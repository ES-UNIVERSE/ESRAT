<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>GangaAI</title>
  <style>
    /* RESET */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; overflow: hidden; }
    body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #0f0f0f; color: #fff; }

    /* ---- LIGHT MODE CORE ---- */
    body.light-mode { background: #f5f5f7; color: #000; }
    body.light-mode::before { background: radial-gradient(1200px 800px at 10% -10%, #e5e5e7 10%, #f5f5f7 60%); }
    body.light-mode::after { background: rgba(255,255,255,0.7); }

    /* Make most UI chrome brighter in light mode */
    body.light-mode .input-area,
    body.light-mode .sidebar,
    body.light-mode .side-search,
    body.light-mode .chat-item,
    body.light-mode .icon-btn,
    body.light-mode .new-chat-btn,
    body.light-mode .prompt-chip { 
      background: rgba(255,255,255,0.9); 
      border-color: rgba(0,0,0,0.1); 
    }
    body.light-mode .settings-panel { 
      background: rgba(255,255,255,0.92); 
      border: 1px solid rgba(0,0,0,0.08); 
      box-shadow: 0 20px 60px rgba(0,0,0,0.12);
    }
    body.light-mode .settings-content { background: transparent; color: #000; }
    body.light-mode .settings-option { border-bottom: 1px solid rgba(0,0,0,0.08); }

    /* Ensure texts look black in light mode (general UI) */
    body.light-mode .brand,
    body.light-mode .listening,
    body.light-mode .chat-name,
    body.light-mode .chip,
    body.light-mode .side-title,
    body.light-mode .new-chat-btn,
    body.light-mode .side-search input,
    body.light-mode .chat-bubble.bot,
    body.light-mode .welcome-message { color: #000; }

    /* Icons & strokes flip to dark in light mode */
    body.light-mode .menu svg,
    body.light-mode .settings-btn svg,
    body.light-mode .side-search svg,
    body.light-mode .icon-btn svg { stroke: #000; }

    /* Bot bubble styling in light mode */
    body.light-mode .chat-bubble.bot { background: rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.08); }

    /* Input field text & placeholder in light mode */
    body.light-mode .field input { color: #000; }
    .field input::placeholder { color: rgba(255,255,255,0.65); }
    body.light-mode .field input::placeholder { color: rgba(0,0,0,0.5); }

    /* BACKGROUND */
    body::before { content: ""; position: fixed; inset: 0; background: radial-gradient(1200px 800px at 10% -10%, #1d1d1f 10%, #0a0a0a 60%); z-index: -2; transition: background 0.3s ease; }
    body::after { content: ""; position: fixed; inset: 0; backdrop-filter: blur(22px) saturate(180%); background: rgba(255,255,255,0.05); z-index: -1; transition: backdrop-filter .3s ease, background .3s ease; }
    body.blur::after { backdrop-filter: blur(28px) saturate(220%); background: rgba(255,255,255,0.12); }

    /* HEADER (enhanced frosted canvas) */
    header { position: fixed; top: 0; left: 0; right: 0; height: 60px; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 20px; font-weight: 600; background: rgba(255,255,255,0.07); backdrop-filter: blur(18px) saturate(180%); border-bottom: 1px solid rgba(255,255,255,0.16); box-shadow: 0 6px 28px rgba(0,0,0,0.25); z-index: 200; }
    body.light-mode header { background: rgba(255,255,255,0.8); border-bottom: 1px solid rgba(0,0,0,0.08); box-shadow: 0 6px 28px rgba(0,0,0,0.08); }
    .brand { letter-spacing: .3px; transition: opacity 0.3s ease; }
    .brand.hidden { opacity: 0; }
    .listening { position: absolute; display: flex; align-items: center; gap: 6px; font-size: 16px; font-weight: 500; opacity: 0; transition: opacity 0.3s ease; }
    .listening.active { opacity: 1; }
    .dot { width: 6px; height: 6px; border-radius: 50%; background: #34c759; animation: pulse 1.2s infinite ease-in-out; }
    .dot:nth-child(2){ animation-delay:.15s } .dot:nth-child(3){ animation-delay:.3s }
    @keyframes pulse { 0%,100%{ transform: scale(.8); opacity:.5 } 50%{ transform: scale(1.3); opacity:1 } }

    /* HAMBURGER / SIDEBAR TOGGLE */
    .menu { position: absolute; left: 10px; top: 10px; width: 40px; height: 40px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.18); background: rgba(255,255,255,0.08); display: grid; place-items:center; cursor: pointer; transition: transform .15s ease; }
    .menu:active { transform: scale(0.95); }
    .menu svg { width: 22px; height: 22px; fill: none; stroke: #fff; stroke-width: 2; stroke-linecap: round; }
    .settings-btn { position: absolute; right: 10px; top: 10px; width: 40px; height: 40px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.18); background: rgba(255,255,255,0.08); display: grid; place-items:center; cursor: pointer; transition: transform .15s ease; }
    .settings-btn:active { transform: scale(0.95); }
    .settings-btn svg { width: 22px; height: 22px; fill: none; stroke: #fff; stroke-width: 2; stroke-linecap: round; }

    /* CHAT CONTAINER */
    .chat-container { position: absolute; top: 60px; bottom: 78px; left: 0; right: 0; overflow-y: auto; overflow-x: hidden; padding: 14px; display: flex; flex-direction: column; gap: 12px; scroll-behavior: smooth; -webkit-overflow-scrolling: touch; }
    .chat-container::-webkit-scrollbar { display: none; }

    .chat-bubble { max-width: 82%; padding: 12px 16px; border-radius: 18px; font-size: 15px; line-height: 1.45; word-wrap: break-word; overflow-wrap: anywhere; white-space: pre-wrap; animation: pop .25s ease; position: relative; }
    .user { align-self: flex-end; background: linear-gradient(135deg, #007aff, #5ac8fa); color: #fff; border-bottom-right-radius: 6px; }
    .bot { align-self: flex-start; background: rgba(255,255,255,0.10); border: 1px solid rgba(255,255,255,0.10); backdrop-filter: blur(10px); border-bottom-left-radius: 6px; }
    .message-time { font-size: 10px; opacity: 0.7; margin-top: 4px; text-align: right; }
    .bot .message-time { text-align: left; }
    @keyframes pop { from{ opacity: 0; transform: translateY(8px) } to{ opacity:1; transform: translateY(0) } }

    /* TYPING INDICATOR */
    .typing { display: inline-flex; gap: 4px; align-items: center; }
    .typing .t { width:6px; height:6px; border-radius:50%; background:#d1d1d6; animation: type 1s infinite; }
    .typing .t:nth-child(2){ animation-delay:.15s } .typing .t:nth-child(3){ animation-delay:.3s }
    @keyframes type { 0%,100%{ transform: translateY(0); opacity:.5 } 50%{ transform: translateY(-4px); opacity:1 } }

    /* INPUT AREA - stronger frosted border/blur */
    .input-area { position: fixed; bottom: 0; left: 0; right: 0; height: 78px; background: rgba(255,255,255,0.06); backdrop-filter: blur(20px) saturate(180%); display: flex; align-items: center; padding: 10px; gap: 10px; z-index: 100; border-top: 1px solid rgba(255,255,255,0.16); box-shadow: 0 -8px 30px rgba(0,0,0,0.25); }
    body.light-mode .input-area { background: rgba(255,255,255,0.86); border-top: 1px solid rgba(0,0,0,0.08); box-shadow: 0 -8px 24px rgba(0,0,0,0.08); }
    .field-wrap { position: relative; flex: 1; height: 48px; }
    .field { position: absolute; inset: 0; display: flex; align-items: center; border-radius: 24px; background: rgba(255,255,255,0.10); padding: 0 14px; overflow: hidden; border: 1px solid rgba(255,255,255,0.18); backdrop-filter: blur(12px) saturate(160%); }
    body.light-mode .field { background: rgba(255,255,255,0.9); border: 1px solid rgba(0,0,0,0.08); }
    .field input { flex: 1; height: 44px; border: none; outline: none; font-size: 16px; background: transparent; color: #fff; }

    /* SUGGESTED PROMPTS */
    .suggested-prompts { position: absolute; bottom: 85px; left: 0; right: 0; padding: 10px; display: flex; gap: 8px; overflow-x: auto; scrollbar-width: none; }
    .suggested-prompts::-webkit-scrollbar { display: none; }
    .prompt-chip { padding: 8px 14px; background: rgba(255,255,255,0.10); border-radius: 16px; font-size: 13px; white-space: nowrap; cursor: pointer; transition: transform 0.1s ease; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.16); }
    .prompt-chip:active { transform: scale(0.95); }

    /* LIVE MIC VISUALIZER - covers entire input field */
    .visualizer { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; gap: 3px; padding: 0 18px; background: rgba(255,255,255,0.10); border-radius: 24px; }
    .bar { width: 4px; background: linear-gradient(180deg, #34c759, #30d158); border-radius: 2px; height: 10px; }

    /* MIC BUTTON */
    .mic-btn { width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, #ff3b30, #ff2d55); display: grid; place-items: center; cursor: pointer; transition: transform .12s ease, filter .2s ease; }
    .mic-btn:active { transform: scale(.95); }
    .mic-btn svg { width: 22px; height: 22px; fill: #fff; }
    .mic-btn.recording { background: linear-gradient(135deg, #ff453a, #ff375f); box-shadow: 0 0 0 8px rgba(255,56,95,0.15); }

    /* SIDEBAR */
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.25); opacity: 0; pointer-events: none; transition: opacity .25s ease; z-index: 250; backdrop-filter: none; }
    .overlay.show { opacity: 1; pointer-events: auto; backdrop-filter: blur(6px); }
    .sidebar { position: fixed; top: 10px; left: 10px; bottom: 10px; width: 86%; max-width: 360px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.12); border-radius: 22px; backdrop-filter: blur(18px); transform: translateX(-120%); transition: transform .28s cubic-bezier(.2,.8,.2,1); z-index: 300; display: flex; flex-direction: column; overflow: hidden; }
    .sidebar.show { transform: translateX(0); }
    .side-head { display:flex; align-items:center; justify-content: space-between; padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.12); }
    .side-title { font-weight: 600; font-size: 16px; }
    .new-chat-btn { padding: 8px 12px; border-radius: 10px; background: rgba(255,255,255,0.10); border: 1px solid rgba(255,255,255,0.12); color: inherit; font-size: 14px; cursor: pointer; transition: transform .1s ease; }
    .new-chat-btn:active { transform: scale(0.95); }
    .side-search { margin: 10px 12px; display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.10); border: 1px solid rgba(255,255,255,0.12); border-radius: 14px; padding: 8px 10px; }
    .side-search input { flex:1; border:none; outline:none; background:transparent; color: inherit; font-size:14px; }

    .chats { overflow-y:auto; padding: 8px; display:flex; flex-direction:column; gap:8px; }
    .chat-item { display:flex; align-items:center; justify-content:space-between; gap:8px; padding:10px 12px; border-radius:14px; background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.10); cursor: pointer; transition: background .2s ease, transform .1s ease; position: relative; }
    .chat-item:hover { background: rgba(255,255,255,0.10); }
    .chat-name { font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .chip { font-size: 11px; opacity:.7 }
    .pin-icon { position: absolute; top: 6px; right: 6px; width: 16px; height: 16px; opacity: 0.7; }
    .actions { display:flex; gap:6px; }
    .icon-btn { width:28px; height:28px; display:grid; place-items:center; border-radius: 10px; border: 1px solid rgba(255,255,255,0.14); background: rgba(255,255,255,0.08); transition: transform .1s ease; }
    .icon-btn:active{ transform: scale(.95) }
    .icon-btn svg { width:16px; height:16px; stroke:#fff; stroke-width:2; fill:none; }

    /* SETTINGS PANEL */
    .settings-panel { position: fixed; top: 10px; right: 10px; bottom: 10px; width: 86%; max-width: 360px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.12); border-radius: 22px; backdrop-filter: blur(18px); transform: translateX(120%); transition: transform .28s cubic-bezier(.2,.8,.2,1); z-index: 300; display: flex; flex-direction: column; overflow: hidden; }
    .settings-panel.show { transform: translateX(0); }
    .settings-content { padding: 16px; overflow-y: auto; }
    .settings-section { margin-bottom: 20px; }
    .settings-section h3 { margin-bottom: 12px; font-size: 16px; font-weight: 600; }
    .settings-option { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .settings-option:last-child { border-bottom: none; }
    .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255,255,255,0.3); transition: .4s; border-radius: 24px; }
    .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: #007AFF; }
    input:checked + .slider:before { transform: translateX(26px); }
    select { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; padding: 8px; color: #fff; }
    body.light-mode select { background: rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.15); color: #000; }

    /* WELCOME MESSAGE — polished card */
    .welcome-message { 
      position: relative; 
      align-self: center; 
      max-width: 780px; 
      width: calc(100% - 28px);
      margin: 16px 0 4px; 
      padding: 18px 18px; 
      border-radius: 18px; 
      background: linear-gradient(180deg, rgba(255,255,255,0.12), rgba(255,255,255,0.06));
      border: 1px solid rgba(255,255,255,0.16);
      backdrop-filter: blur(10px);
      text-align: left; 
      opacity: 1; 
      transition: opacity 0.5s ease; 
    }
    body.light-mode .welcome-message { background: rgba(255,255,255,0.9); border: 1px solid rgba(0,0,0,0.08); }
    .welcome-message.hidden { opacity: 0; pointer-events: none; }
    .welcome-message h2 { 
      font-size: 18px; 
      font-weight: 700; 
      letter-spacing: .2px; 
      margin-bottom: 8px; 
      background: linear-gradient(90deg, #0ea5ff, #8b5cf6, #22c55e); 
      -webkit-background-clip: text; 
      background-clip: text; 
      color: transparent; 
    }
    .welcome-message p { font-size: 14px; opacity: .9; line-height: 1.5; }
    .welcome-message ul { margin-top: 10px; display: grid; grid-template-columns: repeat(auto-fit, minmax(180px,1fr)); gap: 8px 16px; }
    .welcome-message li { font-size: 13px; opacity: .9; list-style: none; }

    /* Utilities */
    .hidden { display: none !important; }

    @media (min-width: 768px){ .chat-bubble{ max-width: 720px } .sidebar, .settings-panel { width: 360px } }
  </style>
</head>
<body>
  <header>
    <div class="menu" id="menuBtn" aria-label="Open sidebar" title="Menu">
      <svg viewBox="0 0 24 24" id="menuIcon"><path d="M4 7h16M4 12h16M4 17h16"/></svg>
    </div>
    <div class="brand">GangaAI</div>
    <div class="listening" id="listening">
      <span>Listening</span>
      <div class="dot"></div><div class="dot"></div><div class="dot"></div>
    </div>
    <div class="settings-btn" id="settingsBtn">
      <svg viewBox="0 0 24 24"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.17.1a2 2 0 0 1-2 0l-.15-.1a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v.44a2 2 0 0 1-1 1.73v2.53a2 2 0 0 1 1 1.72v.44a2 2 0 0 0 2 2h.44a2 2 0 0 1 1.73 1h2.53a2 2 0 0 1 1.72-1h.44a2 2 0 0 0 2-2v-.44a2 2 0 0 1 1-1.73V7.73a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
    </div>
  </header>

  <div class="chat-container" id="chat">
    <div class="welcome-message" id="welcomeMessage">
      <h2>Welcome!</h2>
      <p>Feel free to reach out to me for anything. I can help you with:</p>
      <ul>
        <li>• Cracking complex algorithms & data structures</li>
        <li>• Designing beautiful, responsive websites</li>
        <li>• Data analysis & visualizations</li>
        <li>• Debugging code and performance tuning</li>
        <li>• Brainstorming ideas & writing assistance</li>
        <li>• And much more — just ask ✨</li>
      </ul>
    </div>
  </div>

  <div class="suggested-prompts" id="suggestedPrompts">
    <div class="prompt-chip" data-prompt="What can you help me with?">What can you help me with?</div>
    <div class="prompt-chip" data-prompt="Tell me a fun fact">Tell me a fun fact</div>
    <div class="prompt-chip" data-prompt="How does AI work?">How does AI work?</div>
    <div class="prompt-chip" data-prompt="Write a poem about technology">Write a poem about technology</div>
  </div>

  <div class="input-area">
    <div class="field-wrap">
      <div class="field" id="field">
        <input id="userInput" placeholder="Ask anything..." autocomplete="off" inputmode="text" />
        <!-- visualizer injected here on record -->
      </div>
    </div>
    <button class="mic-btn" id="micBtn" aria-label="Start voice input">
      <svg viewBox="0 0 24 24"><path d="M12 15c1.66 0 3-1.34 3-3V6c0-1.66-1.34-3-3-3S9 4.34 9 6v6c0 1.66 1.34 3 3 3z" fill="#fff"/><path d="M17.3 11c0 3.04-2.46 5.5-5.5 5.5S6.3 14.04 6.3 11H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-1.7z" fill="#fff"/></svg>
    </button>
  </div>

  <!-- Sidebar + overlay -->
  <div class="overlay" id="overlay"></div>
  <aside class="sidebar" id="sidebar" aria-label="Conversations">
    <div class="side-head">
      <div class="side-title">Conversations</div>
      <button class="new-chat-btn" id="newChatBtn">+ New Chat</button>
    </div>
    <div class="side-search">
      <svg viewBox="0 0 24 24" width="16" height="16" stroke="#fff" stroke-width="2" fill="none"><circle cx="11" cy="11" r="7"/><path d="M20 20l-3-3"/></svg>
      <input id="searchChats" placeholder="Search chats" />
    </div>
    <div class="chats" id="chatList"></div>
  </aside>

  <!-- Settings Panel -->
  <aside class="settings-panel" id="settingsPanel">
    <div class="side-head">
      <div class="side-title">Settings</div>
    </div>
    <div class="settings-content">
      <div class="settings-section">
        <h3>Voice Settings</h3>
        <div class="settings-option">
          <span>Voice Output</span>
          <label class="switch">
            <input type="checkbox" id="voiceOutputToggle">
            <span class="slider"></span>
          </label>
        </div>
        <div class="settings-option">
          <span>Language</span>
          <select id="languageSelect">
            <option value="en">English</option>
            <option value="es">Spanish</option>
            <option value="fr">French</option>
            <option value="de">German</option>
            <option value="hi">Hindi</option>
            <option value="ja">Japanese</option>
          </select>
        </div>
      </div>
      <div class="settings-section">
        <h3>Appearance</h3>
        <div class="settings-option">
          <span>Light Mode</span>
          <label class="switch">
            <input type="checkbox" id="themeToggle">
            <span class="slider"></span>
          </label>
        </div>
      </div>
      <div class="settings-section">
        <h3>Sharing</h3>
        <div class="settings-option">
          <span>Enable Chat Sharing</span>
          <label class="switch">
            <input type="checkbox" id="sharingToggle">
            <span class="slider"></span>
          </label>
        </div>
      </div>
    </div>
  </aside>

  <script>
    // ====== STATE & STORAGE ======
    const chatEl = document.getElementById('chat');
    const input = document.getElementById('userInput');
    const field = document.getElementById('field');
    const micBtn = document.getElementById('micBtn');
    const listening = document.getElementById('listening');
    const brand = document.querySelector('.brand');
    const menuBtn = document.getElementById('menuBtn');
    const settingsBtn = document.getElementById('settingsBtn');
    const overlay = document.getElementById('overlay');
    const sidebar = document.getElementById('sidebar');
    const settingsPanel = document.getElementById('settingsPanel');
    const chatList = document.getElementById('chatList');
    const searchChats = document.getElementById('searchChats');
    const newChatBtn = document.getElementById('newChatBtn');
    const suggestedPrompts = document.getElementById('suggestedPrompts');
    const welcomeMessage = document.getElementById('welcomeMessage');
    const promptChips = document.querySelectorAll('.prompt-chip');
    const voiceOutputToggle = document.getElementById('voiceOutputToggle');
    const languageSelect = document.getElementById('languageSelect');
    const themeToggle = document.getElementById('themeToggle');
    const sharingToggle = document.getElementById('sharingToggle');

    const STORAGE_KEY = 'gangaai_chats_v2';
    const SETTINGS_KEY = 'gangaai_settings_v1';
    const MEMORY_KEY = 'gangaai_memory_v1';
    let chats = loadChats();
    let settings = loadSettings();
    let memory = loadMemory();
    let currentId = chats.length ? chats[0].id : createChat().id; // latest first
    let audioContext = null;
    let analyser = null;
    let microphone = null;
    let javascriptNode = null;
    let bars = [];
    let animationId = null;
    let silenceTimer = null;
    let recognition = null;
    let isFirstInteraction = true;
    let speechSynthesis = window.speechSynthesis;

    function uid(){ return 'c_' + Math.random().toString(36).slice(2,9); }
    function now(){ return Date.now(); }
    function loadChats(){ try{ const d = JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); return Array.isArray(d)? d.sort((a,b)=>b.updated-a.updated):[] }catch{ return [] } }
    function saveChats(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(chats)); renderChatList(); }

    function loadSettings(){ 
      try{ 
        const d = JSON.parse(localStorage.getItem(SETTINGS_KEY)||'{}'); 
        return {
          voiceOutput: d.voiceOutput || false,
          language: d.language || 'en',
          theme: d.theme || 'dark',
          sharing: d.sharing || false
        };
      } catch{ 
        return {
          voiceOutput: false,
          language: 'en',
          theme: 'dark',
          sharing: false
        };
      } 
    }

    function saveSettings(){ localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings)); }

    function loadMemory(){ 
      try{ 
        const d = JSON.parse(localStorage.getItem(MEMORY_KEY)||'{}'); 
        return d || {};
      } catch{ 
        return {};
      } 
    }

    function saveMemory(){ localStorage.setItem(MEMORY_KEY, JSON.stringify(memory)); }

    function createChat(title='New Chat'){ 
      const id = uid(); 
      const chat = { id, title, messages: [], created: now(), updated: now(), pinned: false }; 
      chats.unshift(chat); 
      saveChats(); 
      return chat; 
    }

    function getChat(id){ return chats.find(c=>c.id===id); }

    // ====== RENDER ======
    function renderChat(id=currentId){ 
      const c = getChat(id); 
      if(!c) return; 
      chatEl.innerHTML=''; 

      // Add welcome message for empty chats
      if (c.messages.length === 0) {
        welcomeMessage.classList.remove('hidden');
        suggestedPrompts.classList.remove('hidden');
      } else {
        welcomeMessage.classList.add('hidden');
        suggestedPrompts.classList.add('hidden');
      }

      c.messages.forEach(m=> addBubble(m.role, m.content, m.ts, false)); 
      scrollToBottom(); 
    }

    function addBubble(role, text, timestamp, push=true){
      if(push){ 
        const c = getChat(currentId); 
        c.messages.push({ role, content: text, ts: now() }); 
        c.updated = now(); 

        // Add to memory for cross-conversation context
        if (role === 'user') {
          memory.lastUserMessage = text;
        } else if (role === 'bot') {
          memory.lastBotResponse = text;
        }
        saveMemory();

        saveChats(); 

        // Hide welcome & suggestions after first interaction
        if (isFirstInteraction) {
          isFirstInteraction = false;
          welcomeMessage.classList.add('hidden');
          suggestedPrompts.classList.add('hidden');
        }
      }

      const b = document.createElement('div'); 
      b.className = `chat-bubble ${role}`; 

      // Add message content
      const content = document.createElement('div');
      content.textContent = text;
      b.appendChild(content);

      // Add timestamp
      const time = document.createElement('div');
      time.className = 'message-time';
      time.textContent = formatTime(timestamp || now());
      b.appendChild(time);

      chatEl.appendChild(b);

      scrollToBottom();

      // Speak response if voice output is enabled
      if (role === 'bot' && settings.voiceOutput && push) {
        speakText(text);
      }
    }

    function formatTime(timestamp) {
      const date = new Date(timestamp);
      return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function speakText(text) {
      if (!speechSynthesis) return;

      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = settings.language;
      speechSynthesis.speak(utterance);
    }

    function showTyping(){ 
      const wrap = document.createElement('div'); 
      wrap.className = 'chat-bubble bot'; 
      const t = document.createElement('div'); 
      t.className='typing'; 
      t.innerHTML = '<span class="t"></span><span class="t"></span><span class="t"></span>'; 
      wrap.appendChild(t); 
      chatEl.appendChild(wrap); 
      scrollToBottom(); 
      return wrap; 
    }

    function scrollToBottom(){ 
      setTimeout(() => {
        chatEl.scrollTop = chatEl.scrollHeight; 
      }, 100);
    }

    function renderChatList(filter=''){ 
      chatList.innerHTML=''; 
      const q = filter.trim().toLowerCase(); 

      // Separate pinned and unpinned chats
      const pinnedChats = chats.filter(c => c.pinned).filter(c=> !q || c.title.toLowerCase().includes(q));
      const unpinnedChats = chats.filter(c => !c.pinned).filter(c=> !q || c.title.toLowerCase().includes(q));

      // Render pinned chats first
      pinnedChats.forEach(c=> chatList.appendChild(chatListItem(c)));

      // Add separator if there are both pinned and unpinned chats
      if (pinnedChats.length > 0 && unpinnedChats.length > 0) {
        const separator = document.createElement('div');
        separator.style.padding = '8px 12px';
        separator.style.fontSize = '12px';
        separator.style.opacity = '0.7';
        separator.textContent = 'Other conversations';
        chatList.appendChild(separator);
      }

      // Render unpinned chats
      unpinnedChats.forEach(c=> chatList.appendChild(chatListItem(c)));
    }

    function chatListItem(c){ 
      const item = document.createElement('div'); 
      item.className='chat-item'; 
      item.dataset.id=c.id; 
      item.addEventListener('click', (e)=>{ 
        if(e.target.closest('.actions')) return; 
        currentId=c.id; 
        renderChat(); 
        closeSidebar(); 
      });

      const left = document.createElement('div'); 
      left.style.minWidth='0';

      const name = document.createElement('div'); 
      name.className='chat-name'; 
      name.textContent=c.title || 'Untitled';

      const chip = document.createElement('div'); 
      chip.className='chip'; 
      chip.textContent = new Date(c.updated).toLocaleString();

      left.appendChild(name); 
      left.appendChild(chip);

      const actions = document.createElement('div'); 
      actions.className='actions';

      // Pin/unpin button
      const pinBtn = iconBtnSVG('pin', ()=> togglePinChat(c.id));
      pinBtn.innerHTML = c.pinned ? 
        '<svg viewBox="0 0 24 24" fill="#007AFF"><path d="M16 9V4l6 6-6 6v-5c0 0-6.5 0-9 4v-1c2.5-1 9-4 9-4z"/></svg>' :
        '<svg viewBox="0 0 24 24"><path d="M16 9V4l6 6-6 6v-5c0 0-6.5 0-9 4v-1c2.5-1 9-4 9-4z"/></svg>';
      actions.appendChild(pinBtn);

      actions.appendChild(iconBtn('✏️', ()=> renameChat(c.id)));

      // Share button if sharing is enabled
      if (settings.sharing) {
        actions.appendChild(iconBtnSVG('share', ()=> shareChat(c.id)));
      }

      actions.appendChild(iconBtnSVG('delete', ()=> deleteChat(c.id)));
      actions.appendChild(iconBtnSVG('export', ()=> exportChat(c.id)));

      item.appendChild(left); 
      item.appendChild(actions);

      // Add pin icon indicator for pinned chats
      if (c.pinned) {
        const pinIcon = document.createElement('div');
        pinIcon.className = 'pin-icon';
        pinIcon.innerHTML = '<svg viewBox="0 0 24 24" fill="#007AFF"><path d="M16 9V4l6 6-6 6v-5c0 0-6.5 0-9 4v-1c2.5-1 9-4 9-4z"/></svg>';
        item.appendChild(pinIcon);
      }

      return item; 
    }

    function iconBtn(label, onClick){ 
      const b=document.createElement('button'); 
      b.className='icon-btn'; 
      b.textContent=label; 
      b.addEventListener('click', (e)=>{ 
        e.stopPropagation(); 
        onClick(); 
      }); 
      return b; 
    }

    function iconBtnSVG(kind, onClick){ 
      const b=document.createElement('button'); 
      b.className='icon-btn'; 

      if (kind === 'delete') {
        b.innerHTML = '<svg viewBox="0 0 24 24"><path d="M3 6h18M8 6v14a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2V6M9 6l1-2h4l1 2"/></svg>';
      } else if (kind === 'export') {
        b.innerHTML = '<svg viewBox="0 0 24 24"><path d="M12 3v12"/><path d="M7 8l5-5 5 5"/><path d="M5 21h14"/></svg>';
      } else if (kind === 'pin') {
        b.innerHTML = '<svg viewBox="0 0 24 24"><path d="M16 9V4l6 6-6 6v-5c0 0-6.5 0-9 4v-1c2.5-1 9-4 9-4z"/></svg>';
      } else if (kind === 'share') {
        b.innerHTML = '<svg viewBox="0 0 24 24"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8M16 6l-4-4-4 4M12 2v13"/></svg>';
      }

      b.addEventListener('click', (e)=>{ 
        e.stopPropagation(); 
        onClick(); 
      }); 
      return b; 
    }

    // ====== CHAT LOGIC ======
    function sendText(text){ 
      if(!text) return; 
      addBubble('user', text); 
      input.value=''; 
      const typing = showTyping(); 

      // Hide suggestions immediately on first send
      suggestedPrompts.classList.add('hidden');

      // Use memory for context in responses
      let context = "";
      if (memory.lastUserMessage) {
        context += ` Previous user message: ${memory.lastUserMessage}`;
      }
      if (memory.lastBotResponse) {
        context += ` Previous bot response: ${memory.lastBotResponse}`;
      }

      setTimeout(()=>{ 
        typing.remove(); 
        addBubble('bot', generateBotReply(text, context)); 
      }, 600 + Math.min(1200, text.length*30)); 
    }

    function generateBotReply(msg, context=""){ 
      const replies = [
        "Interesting… tell me more!", 
        "I'm here to help you ❤", 
        "That sounds cool!",
        "Can you explain a bit more?", 
        "I like how you're thinking 🤔", 
        "Apple vibes, right? 🍏✨"
      ]; 

      // Enhanced responses with context
      if (context) {
        if (msg.toLowerCase().includes("remember")) {
          return "I remember our previous conversation! " + (memory.lastBotResponse || "How can I help you further?");
        }

        if (msg.toLowerCase().includes("again")) {
          return "Of course! " + (memory.lastBotResponse || "Let me know how else I can help.");
        }
      }

      return replies[Math.floor(Math.random()*replies.length)]; 
    }

    input.addEventListener('keydown', (e)=>{ 
      if(e.key==='Enter'){ 
        e.preventDefault(); 
        sendText(input.value.trim()); 
      } 
    });

    // Hide suggested prompts once user starts typing
    input.addEventListener('input', () => {
      if (input.value.trim().length > 0) {
        suggestedPrompts.classList.add('hidden');
      }
    });

    // ====== SIDEBAR & SETTINGS ======
    function openSidebar(){ 
      sidebar.classList.add('show'); 
      overlay.classList.add('show'); 
      document.body.classList.add('blur'); 
    }

    function closeSidebar(){ 
      sidebar.classList.remove('show'); 
      settingsPanel.classList.remove('show');
      overlay.classList.remove('show'); 
      document.body.classList.remove('blur'); 
      document.body.classList.remove('settings-open');
    }

    function openSettings() {
      settingsPanel.classList.add('show');
      overlay.classList.add('show');
      document.body.classList.add('blur');
      document.body.classList.add('settings-open');
    }

    menuBtn.addEventListener('click', ()=>{ 
      if(sidebar.classList.contains('show')) closeSidebar(); 
      else openSidebar(); 
    });

    settingsBtn.addEventListener('click', openSettings);

    overlay.addEventListener('click', closeSidebar);

    searchChats.addEventListener('input', ()=> renderChatList(searchChats.value));

    newChatBtn.addEventListener('click', () => {
      const newChat = createChat();
      currentId = newChat.id;
      renderChat();
      closeSidebar();
    });

    function togglePinChat(id) {
      const chat = getChat(id);
      if (chat) {
        chat.pinned = !chat.pinned;
        chat.updated = now();
        saveChats();
        renderChatList(searchChats.value);
      }
    }

    function renameChat(id){ 
      const c = getChat(id); 
      if(!c) return; 
      const t = prompt('Rename chat:', c.title||''); 
      if(t !== null) { 
        c.title = t.trim()||'Untitled'; 
        c.updated = now(); 
        saveChats(); 
        renderChatList(searchChats.value); 
      }
    }

    function deleteChat(id){ 
      const i = chats.findIndex(c=>c.id===id); 
      if(i<0) return; 
      const isCurrent = chats[i].id===currentId; 
      chats.splice(i,1); 
      if(!chats.length) createChat(); 
      if(isCurrent) currentId = chats[0].id; 
      saveChats(); 
      renderChat(); 
    }

    function exportChat(id){ 
      const c = getChat(id); 
      if(!c) return; 
      const blob = new Blob([JSON.stringify(c, null, 2)], {type:'application/json'}); 
      const a = document.createElement('a'); 
      a.href = URL.createObjectURL(blob); 
      a.download = (c.title||'chat') + '.json'; 
      document.body.appendChild(a); 
      a.click(); 
      a.remove(); 
      setTimeout(()=> URL.revokeObjectURL(a.href), 1000); 
    }

    function shareChat(id) {
      const c = getChat(id);
      if (!c) return;

      // Create a shareable link (in a real app, this would be a server-generated link)
      const shareData = {
        title: c.title || 'GangaAI Chat',
        text: `Check out my GangaAI conversation: ${c.title}`,
        url: window.location.href + '?shared=' + id
      };

      if (navigator.share) {
        navigator.share(shareData)
          .then(() => console.log('Shared successfully'))
          .catch((error) => console.log('Error sharing:', error));
      } else {
        // Fallback for browsers that don't support Web Share API
        prompt('Copy this link to share:', shareData.url);
      }
    }

    // ====== SETTINGS HANDLERS ======
    voiceOutputToggle.checked = settings.voiceOutput;
    voiceOutputToggle.addEventListener('change', () => {
      settings.voiceOutput = voiceOutputToggle.checked;
      saveSettings();
    });

    languageSelect.value = settings.language;
    languageSelect.addEventListener('change', () => {
      settings.language = languageSelect.value;
      saveSettings();
    });

    themeToggle.checked = settings.theme === 'light';
    themeToggle.addEventListener('change', () => {
      settings.theme = themeToggle.checked ? 'light' : 'dark';
      document.body.classList.toggle('light-mode', themeToggle.checked);
      saveSettings();
    });

    sharingToggle.checked = settings.sharing;
    sharingToggle.addEventListener('change', () => {
      settings.sharing = sharingToggle.checked;
      saveSettings();
      renderChatList(searchChats.value);
    });

    // ====== SUGGESTED PROMPTS ======
    promptChips.forEach(chip => {
      chip.addEventListener('click', () => {
        const prompt = chip.getAttribute('data-prompt');
        input.value = prompt;
        // Hide suggestions immediately when a chip is chosen
        suggestedPrompts.classList.add('hidden');
        sendText(prompt);
      });
    });

    // ====== VOICE (Live Audio Visualization) ======
    let recording = false; 
    let interimBuffer='';

    function startMic(){ 
      if(recording) return; 
      recording = true; 
      micBtn.classList.add('recording'); 
      listening.classList.add('active'); 
      brand.classList.add('hidden');
      showVisualizer(); 
      startSpeechRecognition();
    }

    function stopMic(){ 
      if(!recording) return; 
      recording = false; 
      micBtn.classList.remove('recording'); 
      listening.classList.remove('active'); 
      brand.classList.remove('hidden');
      hideVisualizer();
      stopSpeechRecognition();

      // Auto-send the captured text
      const text = (input.value + ' ' + (interimBuffer||'')).trim(); 
      interimBuffer = ''; 
      if(text) sendText(text);
    }

    function toggleMic(){ 
      if(recording) stopMic(); 
      else startMic(); 
    }

    micBtn.addEventListener('click', toggleMic);

    function showVisualizer(){ 
      input.style.visibility='hidden'; 
      let v=document.createElement('div'); 
      v.className='visualizer'; 
      v.id='viz'; 
      for(let i=0;i<8;i++){ 
        const b=document.createElement('div'); 
        b.className='bar'; 
        b.style.height = '10px';
        v.appendChild(b); 
        bars.push(b);
      } 
      field.appendChild(v); 
    }

    function hideVisualizer(){ 
      const v=document.getElementById('viz'); 
      if(v) v.remove(); 
      input.style.visibility='visible'; 
      bars = [];
    }

    function startSpeechRecognition() {
      try {
        // Check if browser supports SpeechRecognition
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
          alert("Your browser doesn't support speech recognition. Please try Chrome or Edge.");
          stopMic();
          return;
        }

        recognition = new SpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = settings.language;

        recognition.onresult = (event) => {
          clearTimeout(silenceTimer);

          let finalTranscript = '';
          let interimTranscript = '';

          for (let i = event.resultIndex; i < event.results.length; i++) {
            const transcript = event.results[i][0].transcript;
            if (event.results[i].isFinal) {
              finalTranscript += transcript;
            } else {
              interimTranscript += transcript;
            }
          }

          if (finalTranscript) {
            input.value = finalTranscript;
            stopMic(); // Stop when we have final results
          } else if (interimTranscript) {
            input.value = interimTranscript;
          }

          // Reset silence timer (3 seconds)
          silenceTimer = setTimeout(() => {
            if (recording) {
              stopMic();
            }
          }, 3000);
        };

        recognition.onerror = (event) => {
          console.error('Speech recognition error', event.error);
          if (event.error === 'not-allowed') {
            alert('Microphone access is not allowed. Please enable microphone permissions in your browser settings.');
          }
          stopMic();
        };

        recognition.onend = () => {
          if (recording) {
            // If recognition ends but we're still recording, restart it
            try {
              recognition.start();
            } catch (e) {
              console.error('Error restarting recognition:', e);
              stopMic();
            }
          }
        };

        recognition.start();
        animateBars(); // Start the visualization

        // Initial silence timer (3 seconds)
        silenceTimer = setTimeout(() => {
          if (recording) {
            stopMic();
          }
        }, 3000);

      } catch (error) {
        console.error('Error starting speech recognition:', error);
        stopMic();
      }
    }

    function stopSpeechRecognition() {
      if (silenceTimer) {
        clearTimeout(silenceTimer);
        silenceTimer = null;
      }

      if (recognition) {
        try {
          recognition.stop();
        } catch (e) {
          console.error('Error stopping recognition:', e);
        }
        recognition = null;
      }

      if (animationId) {
        cancelAnimationFrame(animationId);
        animationId = null;
      }

      // Ensure microphone is properly released
      if (microphone) {
        try {
          microphone.disconnect();
          microphone = null;
        } catch (e) {
          console.error('Error disconnecting microphone:', e);
        }
      }

      if (audioContext) {
        try {
          audioContext.close();
          audioContext = null;
        } catch (e) {
          console.error('Error closing audio context:', e);
        }
      }
    }

    function animateBars() {
      // Animation for the visualizer bars
      let time = 0;

      function updateBars() {
        time += 0.1;
        for (let i = 0; i < bars.length; i++) {
          // Simulate audio levels with a sine wave
          const height = 10 + Math.abs(Math.sin(time + i * 0.5) * 34);
          bars[i].style.height = height + 'px';
        }
        if (recording) {
          animationId = requestAnimationFrame(updateBars);
        }
      }

      animationId = requestAnimationFrame(updateBars);
    }

    // TAP OUTSIDE SIDEBAR CLOSE (already via overlay), also prevent background scroll when open
    overlay.addEventListener('touchmove', (e)=> e.preventDefault(), {passive:false});

    // INIT
    document.body.classList.toggle('light-mode', settings.theme === 'light');
    renderChat(); 
    renderChatList();
  </script>
</body>
</html>
