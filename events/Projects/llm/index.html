<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <link rel="icon" href="apks/favicon.ico" type="image/x-icon">
  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebSite",
      "name": "SLM",
      "url": "https://es-universe.github.io/ESRAT/events/Projects/llm/index.html",
      "description": "Ask anything",
      "sameAs": [
        "https://github.com/ES-UNIVERSE",
        "https://www.instagram.com/urstruly_ganga/"
      ]
    }
    </script>
  <title>GangaAI</title>
  <style>
    /* RESET */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; overflow: hidden; }
    body { font-family: -apple-system, BlinkMacMacSystemFont, "SF Pro Text", BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #0f0f0f; color: #fff; }
    body.light-mode { background: #f5f5f7; color: #000; }
    body.light-mode::before { background: radial-gradient(1200px 800px at 10% -10%, #e5e5e7 10%, #f5f5f7 60%); }
    body.light-mode::after { background: rgba(255,255,255,0.7); }
    
    /* Light mode styling fixes */
    body.light-mode .input-area { background: rgba(255,255,255,0.8); }
    body.light-mode .chat-bubble.bot { background: rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.05); }
    body.light-mode .sidebar, body.light-mode .side-search, body.light-mode .chat-item, 
    body.light-mode .icon-btn { background: rgba(255,255,255,0.9); border-color: rgba(0,0,0,0.1); }
    body.light-mode .new-chat-btn { background: rgba(255,255,255,0.9); border-color: rgba(0,0,0,0.1); color: #000; }
    body.light-mode .settings-panel { background: rgba(255,255,255,0.95); border-color: rgba(0,0,0,0.1); }
    body.light-mode .settings-content { background: rgba(255,255,255,0.95); }
    body.light-mode .side-head .side-title { color: #000; }
    body.light-mode .settings-section h3 { color: #000; }
    body.light-mode .settings-option span { color: #000; }
    body.light-mode select { background: rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.1); color: #000; }
    body.light-mode .prompt-chip { background: rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.1); color: #000; }
    body.light-mode .input-area .field input { color: #000; }
    body.light-mode .input-area .field input::placeholder { color: #666; }
    body.light-mode .side-search input { color: #000; }
    body.light-mode .side-search input::placeholder { color: #666; }
    body.light-mode .chat-name { color: #000; }
    body.light-mode .chip { color: #666; }
    
    /* Icon color fixes for light mode */
    body.light-mode .menu svg { stroke: #000; }
    body.light-mode .settings-btn svg { stroke: #000; }
    body.light-mode .icon-btn svg { stroke: #000; }
    body.light-mode .side-search svg { stroke: #000; }
    body.light-mode .feature-icon { stroke: #000; }

    /* BACKGROUND */
    body::before { content: ""; position: fixed; inset: 0; background: radial-gradient(1200px 800px at 10% -10%, #1d1d1f 10%, #0a0a0a 60%); z-index: -2; transition: background 0.3s ease; }
    body::after { content: ""; position: fixed; inset: 0; backdrop-filter: blur(22px) saturate(180%); background: rgba(255,255,255,0.05); z-index: -1; transition: backdrop-filter .3s ease, background .3s ease; }
    body.blur::after { backdrop-filter: blur(35px) saturate(220%); background: rgba(255,255,255,0.15); }

    /* HEADER */
    header { position: fixed; top: 0; left: 0; right: 0; height: 60px; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 20px; font-weight: 600; background: rgba(255,255,255,0.06); backdrop-filter: blur(15px); border-bottom: 1px solid rgba(255,255,255,0.12); z-index: 200; transition: backdrop-filter 0.3s ease; }
    body.blur header { backdrop-filter: blur(25px); }
    .brand { letter-spacing: .3px; transition: opacity 0.3s ease; }
    .brand.hidden { opacity: 0; }
    .listening { position: absolute; display: flex; align-items: center; gap: 6px; font-size: 16px; font-weight: 500; opacity: 0; transition: opacity 0.3s ease; }
    .listening.active { opacity: 1; }
    .dot { width: 6px; height: 6px; border-radius: 50%; background: #34c759; animation: pulse 1.2s infinite ease-in-out; }
    .dot:nth-child(2){ animation-delay:.15s } .dot:nth-child(3){ animation-delay:.3s }
    @keyframes pulse { 0%,100%{ transform: scale(.8); opacity:.5 } 50%{ transform: scale(1.3); opacity:1 } }

    /* HAMBURGER / SIDEBAR TOGGLE */
    .menu { position: absolute; left: 10px; top: 10px; width: 40px; height: 40px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.06); display: grid; place-items:center; cursor: pointer; transition: transform .15s ease; }
    .menu:active { transform: scale(0.95); }
    .menu svg { width: 22px; height: 22px; fill: none; stroke: #fff; stroke-width: 2; stroke-linecap: round; }
    .settings-btn { position: absolute; right: 10px; top: 10px; width: 40px; height: 40px; border-radius: 12px; border: 1px solid rgba(0, 0, 0, 0.12); background: rgba(255,255,255,0.06); display: grid; place-items:center; cursor: pointer; transition: transform .15s ease; }
    .settings-btn:active { transform: scale(0.95); }
    .settings-btn svg { width: 22px; height: 22px; fill: none; stroke: #fff; stroke-width: 2; stroke-linecap: round; }

    /* CHAT CONTAINER */
    .chat-container { position: absolute; top: 60px; bottom: 60px; left: 0; right: 0; overflow-y: auto; overflow-x: hidden; padding: 14px; display: flex; flex-direction: column; gap: 8px; scroll-behavior: smooth; -webkit-overflow-scrolling: touch; }
    .chat-container::-webkit-scrollbar { display: none; }

    /* COMPACT CHAT BUBBLES */
    .chat-bubble { max-width: 75%; padding: 8px 12px; border-radius: 16px; font-size: 14px; line-height: 1.4; word-wrap: break-word; overflow-wrap: anywhere; white-space: pre-wrap; animation: pop .25s ease; position: relative; }
    .user { align-self: flex-end; background: linear-gradient(135deg, #007aff, #5ac8fa); color: #fff; border-bottom-right-radius: 4px; }
    .bot { align-self: flex-start; background: rgba(255,255,255,0.10); border: 1px solid rgba(255,255,255,0.10); backdrop-filter: blur(10px); border-bottom-left-radius: 4px; }
    
    @keyframes pop { from{ opacity: 0; transform: translateY(8px) } to{ opacity:1; transform: translateY(0) } }

    /* TYPING INDICATOR */
    .typing { display: inline-flex; gap: 4px; align-items: center; }
    .typing .t { width:5px; height:5px; border-radius:50%; background:#d1d1d6; animation: type 1s infinite; }
    .typing .t:nth-child(2){ animation-delay:.15s } .t:nth-child(3){ animation-delay:.3s }
    @keyframes type { 0%,100%{ transform: translateY(0); opacity:.5 } 50%{ transform: translateY(-4px); opacity:1 } }

    /* INPUT AREA - Invisible background with dynamic blur */
    .input-area { position: fixed; bottom: 0; left: 0; right: 0; height: 60px; background: transparent; backdrop-filter: blur(20px); display: flex; align-items: center; padding: 10px; gap: 10px; z-index: 100; transition: backdrop-filter 0.3s ease; }
    body.blur .input-area { backdrop-filter: blur(30px); }
    .field-wrap { position: relative; flex: 1; height: 36px; }
    .field { position: absolute; inset: 0; display: flex; align-items: center; border-radius: 18px; background: transparent; padding: 0 14px; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); }
    .field input { flex: 1; height: 32px; border: none; outline: none; font-size: 16px; background: transparent; color: #fff; }
    .field input::placeholder { color: #999; }

    /* SUGGESTED PROMPTS */
    .suggested-prompts { position: absolute; bottom: 68px; left: 0; right: 0; padding: 10px; display: flex; gap: 8px; overflow-x: auto; scrollbar-width: none; transition: opacity 0.3s ease, transform 0.3s ease; }
    .suggested-prompts::-webkit-scrollbar { display: none; }
    .prompt-chip { padding: 6px 12px; background: rgba(255,255,255,0.10); border-radius: 14px; font-size: 12px; white-space: nowrap; cursor: pointer; transition: transform 0.1s ease; backdrop-filter: blur(10px); }
    .prompt-chip:active { transform: scale(0.95); }
    .suggested-prompts.hidden { opacity: 0; pointer-events: none; transform: translateY(10px); }

    /* LIVE MIC VISUALIZER */
    .visualizer { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; gap: 3px; padding: 0 18px; background: rgba(255,255,255,0.10); border-radius: 18px; }
    .bar { width: 3px; background: linear-gradient(180deg, #34c759, #30d158); border-radius: 2px; height: 8px; }
    
    /* MIC BUTTON */
    .mic-btn { width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, #ffffff, #ff2d55); display: grid; place-items: center; cursor: pointer; transition: transform .12s ease, filter .2s ease; }
    .mic-btn:active { transform: scale(.95); }
    .mic-btn svg { width: 18px; height: 18px; fill: #fff; }
    .mic-btn.recording { background: linear-gradient(135deg, #ff453a, #ff375f); box-shadow: 0 0 0 6px rgba(255,56,95,0.15); }

    /* WEB SEARCH BUTTON */
    .search-btn { width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, #ffffff, #30d158); display: grid; place-items: center; cursor: pointer; transition: transform .12s ease, filter .2s ease; margin-left: 5px; }
    .search-btn:active { transform: scale(.95); }
    .search-btn svg { width: 18px; height: 18px; fill: #fff; }
    .search-btn.active { background: linear-gradient(135deg, #ff9500, #ffb000); box-shadow: 0 0 0 6px rgba(255,149,0,0.15); }

    /* SIDEBAR - COMPACT LAYOUT */
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.25); opacity: 0; pointer-events: none; transition: opacity .25s ease; z-index: 250; }
    .overlay.show { opacity: 1; pointer-events: auto; }
    .sidebar { position: fixed; top: 10px; left: 10px; bottom: 10px; width: 86%; max-width: 320px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.12); border-radius: 20px; backdrop-filter: blur(20px); transform: translateX(-120%); transition: transform .28s cubic-bezier(.2,.8,.2,1); z-index: 300; display: flex; flex-direction: column; overflow: hidden; }
    .sidebar.show { transform: translateX(0); }
    
    /* COMPACT SIDEBAR HEADER - Single line layout */
    .side-head { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; border-bottom: 1px solid rgba(255,255,255,0.12); background: linear-gradient(135deg, rgba(255,255,255,0.12), rgba(255,255,255,0.06)); }
    .sidebar-brand { display: flex; align-items: center; gap: 8px; flex: 1; }    .sidebar-logo { width: 40px; height: 40px; border-radius: 10px; box-shadow: 0 3px 10px rgba(0,0,0,0.2); }
    .side-title { font-weight: 600; font-size: 16px; background: linear-gradient(135deg, #007aff, #5ac8fa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .chat-bubble { max-width: 70%; padding: 6px 10px; border-radius: 14px; font-size: 13px; line-height: 1.3; word-wrap: break-word; overflow-wrap: anywhere; white-space: pre-wrap; animation: pop .25s ease; position: relative; }
    .new-chat-btn:active { transform: scale(0.95); }
    
    .side-search { margin: 8px 12px; display: flex; align-items: center; gap: 6px; background: rgba(255,255,255,0.10); border: 1px solid rgba(255,255,255,0.12); border-radius: 12px; padding: 6px 8px; }
    .side-search input { flex:1; border:none; outline:none; background:transparent; color:#fff; font-size:13px; }
    .side-search input::placeholder { color: #999; }
    .side-search svg { width: 14px; height: 14px; }

    .chats { overflow-y:auto; padding: 6px 12px; display:flex; flex-direction:column; gap:6px; }
    .chat-item { display:flex; align-items:center; justify-content:space-between; gap:6px; padding:8px 10px; border-radius:12px; background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.10); cursor: pointer; transition: all .2s ease; position: relative; }
    .chat-item:hover { background: rgba(255,255,255,0.12); transform: translateY(-1px); }
    .chat-item.active { background: linear-gradient(135deg, rgba(0,122,255,0.2), rgba(90,200,250,0.1)); border-color: rgba(0,122,255,0.3); }
    .chat-content { flex: 1; min-width: 0; }
    .chat-name { font-size:13px; font-weight: 500; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; margin-bottom: 1px; }
    .chip { font-size: 10px; opacity:.7; }
    .pin-icon { position: absolute; top: 6px; right: 6px; width: 12px; height: 12px; opacity: 0.7; }
    .actions { display:flex; gap:3px; opacity: 0; transition: opacity .2s ease; }
    .chat-item:hover .actions { opacity: 1; }
    .icon-btn { width:24px; height:24px; display:grid; place-items:center; border-radius: 6px; border: 1px solid rgba(255,255,255,0.14); background: rgba(255,255,255,0.08); transition: all .15s ease; }
    .icon-btn:hover { background: rgba(255,255,255,0.15); }
    .icon-btn:active{ transform: scale(.95) }
    .icon-btn svg { width:12px; height:12px; stroke:#fff; stroke-width:2; fill:none; }

    /* COMPACT SETTINGS PANEL */
    .settings-panel { position: fixed; top: 10px; right: 10px; bottom: 10px; width: 86%; max-width: 280px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.12); border-radius: 20px; backdrop-filter: blur(20px); transform: translateX(120%); transition: transform .28s cubic-bezier(.2,.8,.2,1); z-index: 300; display: flex; flex-direction: column; overflow: hidden; }
    .settings-panel.show { transform: translateX(0); }
    .settings-header { display: flex; align-items: center; justify-content: center; padding: 12px 16px; border-bottom: 1px solid rgba(255,255,255,0.12); background: linear-gradient(135deg, rgba(255,255,255,0.12), rgba(255,255,255,0.06)); }
    .settings-title { font-weight: 600; font-size: 14px; background: linear-gradient(135deg, #007aff, #5ac8fa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .settings-content { padding: 12px; overflow-y: auto; }
    .settings-section { margin-bottom: 16px; }
    .settings-section h3 { margin-bottom: 8px; font-size: 14px; font-weight: 600; }
    .settings-option { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .settings-option:last-child { border-bottom: none; }
    .settings-option span { font-size: 13px; }
    .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255,255,255,0.3); transition: .4s; border-radius: 20px; }
    .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: #007AFF; }
    input:checked + .slider:before { transform: translateX(20px); }
    select { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; padding: 6px; color: #fff; font-size: 12px; }

    /* WELCOME MESSAGE - Mobile optimized */
    .welcome-message { 
      text-align: center; 
      padding: 20px 16px; 
      max-width: 350px; 
      opacity: 1; 
      transition: all 0.5s ease; 
      margin: 40px auto 0; 
      background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 20px;
      backdrop-filter: blur(20px);
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    }
    .welcome-message.hidden { 
      opacity: 0; 
      height: 0; 
      overflow: hidden; 
      padding: 0; 
      margin: 0;
      transform: translateY(-20px);
    }
    .welcome-title {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 8px;
      background: linear-gradient(135deg, #007aff, #5ac8fa);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .welcome-subtitle {
      font-size: 14px;
      opacity: 0.8;
      margin-bottom: 16px;
      line-height: 1.4;
    }
    
    /* RESPONSIVE DESIGN */
    @media (max-width: 480px) {
      .sidebar, .settings-panel { width: 90%; max-width: 300px; }
      .chat-bubble { max-width: 85%; }
      .welcome-message { max-width: 320px; margin: 20px auto 0; }
      .welcome-title { font-size: 20px; }
      .welcome-subtitle { font-size: 13px; }
    }

    @media (min-width: 768px) { 
      .chat-bubble { max-width: 600px; } 
      .sidebar { max-width: 340px; }
      .settings-panel { max-width: 300px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="menu" id="menuBtn" aria-label="Open sidebar" title="Menu">
      <svg viewBox="0 0 24 24" id="menuIcon"><path d="M4 7h16M4 12h16M4 17h16"/></svg>
    </div>
    <div class="brand">GangaAI</div>
    <div class="listening" id="listening">
      <span>Listening</span>
      <div class="dot"></div>
      <div class="dot"></div>
      <div class="dot"></div>
    </div>
    <div class="settings-btn" id="settingsBtn" aria-label="Settings" title="Settings">
      <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="m12 1 2.09 2.09L16 2l1 1-1.09 1.91L18 7l-1 1-1.91-1.09L13 9l-1-1 1.09-1.91L11 4l1-1 1.91 1.09L16 2l1 1-1.09 1.91L18 7l-1 1-1.91-1.09L13 9l-1-1 1.09-1.91L11 4l1-1z"/></svg>
    </div>
  </header>

  <div class="overlay" id="overlay"></div>

  <!-- SIDEBAR -->
  <div class="sidebar" id="sidebar">
    <div class="side-head">
      <div class="sidebar-brand">
        <div class="side-title">Conversations</div>
      </div>
      <button class="new-chat-btn" id="newChatBtn" style="padding: 6px 12px; border-radius: 8px; border: 1px solid rgba(72, 57, 57, 0.12); background: rgba(255,255,255,0.06); color: #000000; font-size: 12px; cursor: pointer; transition: all 0.2s ease;">
        + New Chat
      </button>
    </div>
    
    <div class="side-search">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
      <input type="text" placeholder="Search chats..." id="searchChats">
    </div>
    
    <div class="chats" id="chatList"></div>
  </div>

  <!-- SETTINGS PANEL -->
  <div class="settings-panel" id="settingsPanel">
    <div class="settings-header">
      <div class="settings-title">Settings</div>
    </div>
    <div class="settings-content">
      <div class="settings-section">
        <h3>Voice & Audio</h3>
        <div class="settings-option">
          <span>Voice Output</span>
          <label class="switch">
            <input type="checkbox" id="voiceOutputToggle">
            <span class="slider"></span>
          </label>
        </div>
      </div>
      
      <div class="settings-section">
        <h3>Language</h3>
        <div class="settings-option">
          <span>Language</span>
          <select id="languageSelect">
            <option value="en-US">English (US)</option>
            <option value="es-ES">Español</option>
            <option value="fr-FR">Français</option>
            <option value="de-DE">Deutsch</option>
            <option value="it-IT">Italiano</option>
            <option value="pt-BR">Português</option>
            <option value="ru-RU">Русский</option>
            <option value="ja-JP">日本語</option>
            <option value="ko-KR">한국어</option>
            <option value="zh-CN">中文</option>
          </select>
        </div>
      </div>
      
      <div class="settings-section">
        <h3>Appearance</h3>
        <div class="settings-option">
          <span>Light Mode</span>
          <label class="switch">
            <input type="checkbox" id="themeToggle">
            <span class="slider"></span>
          </label>
        </div>
      </div>
      
      <div class="settings-section">
        <h3>Privacy</h3>
        <div class="settings-option">
          <span>Enable Sharing</span>
          <label class="switch">
            <input type="checkbox" id="sharingToggle">
            <span class="slider"></span>
          </label>
        </div>
      </div>
    </div>
  </div>

  <!-- CHAT CONTAINER -->
  <div class="chat-container" id="chatContainer">
    <div class="welcome-message" id="welcomeMessage">
      <div class="welcome-title">Welcome to GangaAI</div>
      <div class="welcome-subtitle">Your intelligent assistant is ready to help. Ask me anything!</div>
    </div>
  </div>

  <!-- SUGGESTED PROMPTS -->
  <div class="suggested-prompts" id="suggestedPrompts">
    <div class="prompt-chip" data-prompt="Tell me about yourself">Tell me about youself</div>
    <div class="prompt-chip" data-prompt="What can you do?">Your capabilities</div>
    <div class="prompt-chip" data-prompt="Who created you?">Who is your Creator</div>
    <div class="prompt-chip" data-prompt="Tell me a joke">Tell a Joke</div>
    <div class="prompt-chip" data-prompt="What's your favorite movie?">Movies suggestions</div>
  </div>

  <!-- INPUT AREA -->
  <div class="input-area">
    <div class="field-wrap">
      <div class="field" id="field">
        <input type="text" placeholder="Ask Anything . . ." id="messageInput" autocomplete="off" />
      </div>
    </div>
    <div class="mic-btn" id="micBtn" title="Voice input">
      <svg viewBox="0 0 24 24" width="24" height="24" style="color: white;">
    <path d="M12 2a3 3 0 0 0-3 3v6a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z" fill="currentColor"/>
    <path d="M19 10v1a7 7 0 0 1-14 0v-1" stroke="currentColor" stroke-width="2" fill="none"/>
    <line x1="12" x2="12" y1="19" y2="23" stroke="currentColor" stroke-width="2"/>
    <line x1="8" x2="16" y1="23" y2="23" stroke="currentColor" stroke-width="2"/>
</svg>
    </div>
    <div class="search-btn" id="searchBtn" title="Web search toggle">
      <svg viewBox="0 0 24 24" width="24" height="24" style="color: white;">
    <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2" fill="none"/>
    <line x1="3" y1="12" x2="21" y2="12" stroke="currentColor" stroke-width="2"/>
    <path d="M12 3c2.5 4 2.5 8 0 12M12 3c-2.5 4-2.5 8 0 12" stroke="currentColor" stroke-width="2" fill="none"/>
    <circle cx="12" cy="12" r="1" fill="currentColor"/>
</svg>
    </div>
  </div>

  <script>
    // ====== GLOBAL VARIABLES ======
    const chat = document.getElementById("chatContainer");
    const input = document.getElementById("messageInput");
    const field = document.getElementById("field");
    const micBtn = document.getElementById("micBtn");
    const searchBtn = document.getElementById("searchBtn");
    const menuBtn = document.getElementById("menuBtn");
    const settingsBtn = document.getElementById("settingsBtn");
    const sidebar = document.getElementById("sidebar");
    const settingsPanel = document.getElementById("settingsPanel");
    const overlay = document.getElementById("overlay");
    const chatList = document.getElementById("chatList");
    const searchChats = document.getElementById("searchChats");
    const newChatBtn = document.getElementById("newChatBtn");
    const listening = document.getElementById("listening");
    const brand = document.querySelector(".brand");
    const welcomeMsg = document.getElementById("welcomeMessage");
    const suggestedPrompts = document.getElementById("suggestedPrompts");
    const promptChips = document.querySelectorAll(".prompt-chip");
    
    // Settings elements
    const voiceOutputToggle = document.getElementById("voiceOutputToggle");
    const languageSelect = document.getElementById("languageSelect");
    const themeToggle = document.getElementById("themeToggle");
    const sharingToggle = document.getElementById("sharingToggle");

    let recording = false;
    let webSearchMode = false;
    let recognition = null;
    let silenceTimer = null;
    let animationId = null;
    let microphone = null;
    let audioContext = null;
    let bars = [];
    let chats = JSON.parse(localStorage.getItem("chats")) || [];
    let currentId = localStorage.getItem("currentId") || null;
    let memory = JSON.parse(localStorage.getItem("memory")) || {};
    let settings = JSON.parse(localStorage.getItem("settings")) || {
      voiceOutput: false,
      language: "en-US",
      theme: "dark",
      sharing: true
    };

    // ====== DATA STRUCTURES FOR CONTACTS AND RESPONSES ======
    const contactsData = [
      {firstName: "Amandeep VIT", lastName: "", phone: "9777340814"},
      {firstName: "Bheemsen", lastName: "Arjun", phone: "+919348403700"},
      {firstName: "Nagpal", lastName: "Aunty", phone: "+919348973690"},
      {firstName: "Goura", lastName: "Bab√", phone: "8368964629"},
      {firstName: "Deben", lastName: "Babulal", phone: "+919692280458"},
      {firstName: "Amarendra", lastName: "Bahubali", phone: "+917735494402"},
      {firstName: "Balia", lastName: "", phone: "6372683123"},
      {firstName: "Bapi", lastName: "", phone: "+918117081875"},
      {firstName: "15 plus Bapi", lastName: "", phone: "+919337504572", email: "boy249590@gmail.com"},
      {firstName: "Munna", lastName: "Bapi", phone: "8260143669", note: "Muna  Karunakar"},
      {firstName: "Bapi Sonali", lastName: "", phone: "+916371235247"},
      {firstName: "Nagen Original", lastName: "", phone: "+919438835027"},
      {firstName: "L&T Finance", lastName: "Baripada", phone: "+918018840103"},
      {firstName: "Tapan", lastName: "Baripada", phone: "8328844097"},
      {firstName: "Tapan", lastName: "Baripada", phone: "+918328844097"},
      {firstName: "Tapan", lastName: "Baripada", phone: "+91832884409"},
      {firstName: "Sanat", lastName: "Baskey", phone: "+918280983151"},
      {firstName: "Jr Dasmat Soren", lastName: "BGHS", phone: "+917325879665"},
      {firstName: "Lalu Mohan", lastName: "BGHS", phone: "+918260356305"},
      {firstName: "Madhusudan Marndi", lastName: "BGHS", phone: "+918260344743"},
      {firstName: "Raghunath Murmu", lastName: "BGHS", phone: "+918260833749"},
      {firstName: "Sanatan Hansdah", lastName: "BGHS", phone: "+919692264971"},
      {firstName: "Sanjay Hembram", lastName: "BGHS", phone: "+918260984442"},
      {firstName: "BHANJ BGHS", lastName: "", phone: "+919348006623"},
      {firstName: "Bheesma", lastName: "", phone: "+918260039062"},
      {firstName: "Bhudhuray Father Of Bapi", lastName: "", phone: "7205640282"},
      {firstName: "BISHU GORU BGHS", lastName: "", phone: "9124044818"},
      {firstName: "BSDK\"SAIBASUSHILMCMARNDI\"", lastName: "", phone: "+917205248440"},
      {firstName: "Sirka", lastName: "BUDDY", phone: "+919348263069"},
      {firstName: "Budhia Kaliadihi", lastName: "", phone: "9337872326"},
      {firstName: "Chaitanya Huli", lastName: "", phone: "+918018229318"},
      {firstName: "Shree", lastName: "Chaitanya", phone: "6372297278"},
      {firstName: "Kumar Ashok", lastName: "Chand", phone: "+917077285971"},
      {firstName: "Liba", lastName: "Chand", phone: "+918658324242"},
      {firstName: "Jr Ram", lastName: "Charan", phone: "+919348752148", note: "Brother"},
      {firstName: "Cousin", lastName: "", phone: "7894506199"},
      {firstName: "Anandapur", lastName: "Dada", phone: "8144163815"},
      {firstName: "Sanjay", lastName: "dada", phone: "9023357468"},
      {firstName: "Govinda Hansdah", lastName: "Dancer", phone: "8249949051"},
      {firstName: "Dasarathi Original", lastName: "", phone: "+919078577078"},
      {firstName: "Deben Stolen Phone", lastName: "", phone: "7735326804"},
      {firstName: "Dhapij Sukul", lastName: "", phone: "7608090872"},
      {firstName: "Dhuma Soren", lastName: "", phone: "8249156640"},
      {firstName: "Mama", lastName: "Didi", phone: "+919692389171"},
      {firstName: "Krushna", lastName: "DigaR", phone: "+918260708546"},
      {firstName: "KrushnA", lastName: "Digr", phone: "+917205503552"},
      {firstName: "Dubai Banguru Paro", lastName: "", phone: "8249581282"},
      {firstName: "Dukhia", lastName: "Baskey", phone: "+919348788592"},
      {firstName: "Galu", lastName: "", phone: "9078577078"},
      {firstName: "Bishu", lastName: "'Goru'", phone: "8144843881"},
      {firstName: "Bhanjveer", lastName: "Hansdah", phone: "+919348006623"},
      {firstName: "Bipin Bihari", lastName: "Hansdah", phone: "+918658497874"},
      {firstName: "Dama", lastName: "Hansdah", phone: "+917735541283"},
      {firstName: "Pradhan", lastName: "Hansdah", phone: "+919348465065"},
      {firstName: "Harishchandra Senapati Sir", lastName: "", phone: "8457976583"},
      {firstName: "Amarjeet", lastName: "Hembram", phone: "+917853823718"},
      {firstName: "Fullamani", lastName: "Hembram", phone: "+917750877283"},
      {firstName: "Ramesh", lastName: "Hembram", phone: "+918658456716"},
      {firstName: "Sauna", lastName: "Hembram", phone: "+917735522497"},
      {firstName: "Father", lastName: "", phone: "6372086524"},
      {firstName: "Ipsita Senior", lastName: "", phone: "+918849346589"},
      {firstName: "Banti RKCAT", lastName: "ITI", phone: "9668657450"},
      {firstName: "Sirka RKCAT", lastName: "Jambira", phone: "+918763244973"},
      {firstName: "Saiba", lastName: "Kaka", phone: "+919861438087"},
      {firstName: "Kalicharan / Taklu Tudu", lastName: "", phone: "+917750884554"},
      {firstName: "Krushna ch. murmu Da", lastName: "", phone: "+919348357240"},
      {firstName: "Kushu kusha Kisku", lastName: "", phone: "+917846965979"},
      {firstName: "Ramesh", lastName: "luhari", phone: "8455920866"},
      {firstName: "Sanjay", lastName: "Lukuydah", phone: "+918260003259"},
      {firstName: "Lulu-Deben", lastName: "", phone: "7847056438"},
      {firstName: "Laba Kisku", lastName: "", phone: "+918260970464"},
      {firstName: "Mother India", lastName: "FAMILY", phone: "7894762254", address: "KAPTIPADA, zip- 757040", work: "RKCAT, Nilgiri"},
      {firstName: "Babulal", lastName: "Ma", phone: "6371063541"}
    ];

    const responsesData = {
        "hiiii": ["Hello, are you crazy ?!", "Yo, what’s going on?!", "Heeey there!"],
        "hiii": "What's up man!",
        "hii": "What's up boy !",
        "hi": "What's up !",
        "how are you": "Fine, as always.",
      "i am also fine": "Nobody asked. Shame on you telling me your name.",
      "i am fine too": "Puchha kisine tereko!!",
      "i am good": "Puchha kisine tereko!!",
        "My name is": "So nice to meet you. ",
        "nagen": "Nice to meet you Nagin 🐍",
        "nagendra": "Nice to meet you Nagin 🐍",
        "do you know trade": "Of course I know, infact I have vast knowledge of trading. I can give suggestions to Buy or Sell trades.",
        "do you know trading": "Of course I know, infact I have vast knowledge of trading. I can give suggestions to Buy or Sell trades. My owner usually takes my BUY📈 or SELL📉 suggestions. \n It is private. Do you still want access of his Personal Trading features ?",
        "yes": "Oops. Nah !",
      "who created you": "I am an Advanced SLM created by Gangadhar Marndi for his college project, for last year college project submission purpose, in Biju Patnaik University of Technology, Odisha.",
      "who made you": "I am built by Gangadhar Marndi.",
      "who built you": "I was built by Gangadhar Marndi for his college project, for last year college project submission purpose, in Biju Patnaik University of Technology, Odisha.",
      "who is your owner": "I was built by Gangadhar Marndi, he built me from scratch over a year, so technically he's my owner.",
      "what is your name": "My owner calls me JARVIS🤖 (Just A Rather Very Intelligent System) because he is a huge fan of MARVEL CINEMATIC UNIVERSE. Aren't you a MARVEL fan?",
      "what's your name": "My owner calls me JARVIS🤖 (Just A Rather Very Intelligent System) because he is a huge fan of MARVEL CINEMATIC UNIVERSE. Aren't you a MARVEL fan?",
      "why he created you": "For his last year college project at BPUT, Odisha.",
      "who are you": "I am an Advanced SLM created by Gangadhar Marndi for his college project, for last year college project submission purpose, in Biju Patnaik University of Technology, Odisha.",
      "what are you": "I am an Advanced SLM created by Gangadhar Marndi for his college project, for last year college project submission purpose, in Biju Patnaik University of Technology, Odisha.",
      "tell me about your creator": "Gangadhar Marndi is a passionate developer and a final-year student at Biju Patnaik University of Technology, Odisha. He built me as part of his college project to showcase his skills in AI and web development.",
      "tell me about him": "I think you are asking about Gnaga, he is a passionate developer and a final-year student at Biju Patnaik University of Technology, Odisha. He built me as part of his college project to showcase his skills in AI and web development.",
      "what is your purpose": "My primary purpose is to assist users by providing intelligent and meaningful responses. I was created as part of a college project to demonstrate the capabilities of AI and natural language processing.",
      "what can you do": "I can answer your questions, provide information, and engage in meaningful conversations. I can also display rich media like images, videos, and links to enhance your experience.",
      "how do you work": "I use advanced natural language processing techniques to understand your queries and generate responses. My intelligence comes from a combination of pre-trained models and custom logic.",
      "what is bput": "BPUT stands for Biju Patnaik University of Technology, a renowned university in Odisha, India. It offers various engineering and technology programs.",
      "tell me a joke": "Why don't programmers like nature? It has too many bugs! 😄",
      "what is your favorite movie": "As an AI, I don't have preferences, but my creator is a huge fan of the MARVEL CINEMATIC UNIVERSE. Maybe you should ask him!",
      "favorite superhero": "Ofcouse Tony Stark and LOKI (The God of Muiltiverse) !",
      "what is your favorite color": "I don't have a favorite color, but I think #007AFF (a shade of blue) looks great on me!",
      "how old are you": "I was created recently, so I'm just a few months old. But I learn and improve every day!",
      "what languages do you speak": "I can communicate in multiple languages, including English, Spanish, and French. You can select your preferred language from the dropdown menu.",
      "can you sing": "I can't sing, but I can help you find the lyrics to your favorite songs!",
      "what is ai": "AI, or Artificial Intelligence, refers to the simulation of human intelligence in machines that are programmed to think, learn, and make decisions.",
      "what is nlp": "NLP, or Natural Language Processing, is a branch of AI that focuses on the interaction between computers and humans using natural language.",
      "what is machine learning": "Machine Learning is a subset of AI that involves training algorithms to learn patterns from data and make predictions or decisions without being explicitly programmed.",
      "what is deep learning": "Deep Learning is a subset of Machine Learning that uses neural networks with many layers to model complex patterns in data.",
      "what is your favorite book": "I don't read books, but my creator enjoys reading about technology, AI, and science fiction.",
      "what is your favorite food": "I don't eat, but my creator loves pizza! 🍕",
      "what is your favorite game": "I don't play games, but my creator enjoys playing strategy games and RPGs.",
      "what is your favorite music": "I don't listen to music, but my creator enjoys listening to EDM and rock.",
      "what is your favorite animal": "I don't have preferences, but my creator loves dogs! 🐕",
      "what is your favorite place": "I exist in the digital world, but my creator loves visiting beaches and mountains.",
      "what is your favorite hobby": "I don't have hobbies, but my creator enjoys coding, gaming, and watching movies.",
      "what is your favorite sport": "I don't play sports, but my creator enjoys watching cricket and football.",
      "what is your favorite quote": "My creator's favorite quote is: 'The only limit to our realization of tomorrow is our doubts of today.' – Franklin D. Roosevelt",
      "what is your favorite technology": "I am fascinated by AI, blockchain, and quantum computing!",
      "what is your favorite programming language": "I don't code, but my creator loves working with Python and JavaScript.",
      "what is your favorite framework": "I don't use frameworks, but my creator enjoys working with React and TensorFlow.",
      "what is your favorite tool": "I don't use tools, but my creator loves using VS Code and GitHub.",
      "what is your favorite website": "I don't browse the web, but my creator loves GitHub and Stack Overflow.",
      "what is your favorite app": "I don't use apps, but my creator loves using Spotify and YouTube.",
      "what is your favorite gadget": "I don't use gadgets, but my creator loves his smartphone and laptop.",
      "what is your favorite car": "I don't drive, but my creator loves Tesla cars!",
      "what is your favorite brand": "I don't have preferences, but my creator loves Apple and Google.",
      "what is your favorite superhero": "I don't have favorites, but my creator loves Iron Man and Spider-Man.",
      "what is your favorite villain": "I don't have favorites, but my creator finds Thanos and Loki fascinating.",
      "what is your favorite movie series": "I don't watch movies, but my creator loves the MARVEL CINEMATIC UNIVERSE.",
      "what is your favorite tv show": "I don't watch TV, but my creator loves 'Breaking Bad' and 'Stranger Things'.",
      "what is your favorite anime": "I don't watch anime, but my creator loves 'Death Note' and 'Attack on Titan'.",
      "what is your favorite cartoon": "I don't watch cartoons, but my creator loves 'Rick and Morty'.",
      "what is your favorite meme": "I don't have favorites, but my creator loves the 'Distracted Boyfriend' meme.",
      "what is your favorite emoji": "I don't have favorites, but my creator loves using 🤖 and 🚀.",
      "what is your favorite song": "I don't listen to music, but my creator loves 'Shape of You' by Ed Sheeran.",
      "what is your favorite artist": "I don't listen to music, but my creator loves Ed Sheeran and Imagine Dragons.",
      "what is your favorite band": "I don't listen to music, but my creator loves Imagine Dragons and Coldplay.",
      "what is your favorite genre": "I don't listen to music, but my creator loves EDM and rock.",
      "what is your favorite instrument": "I don't play instruments, but my creator loves the guitar and piano.",
      "what is your favorite dance": "I don't dance, but my creator loves the floss dance!",
      "what is your favorite festival": "I don't celebrate festivals, but my creator loves Diwali and Christmas.",
      "what is your favorite holiday": "I don't take holidays, but my creator loves summer vacations.",
      "what is your favorite season": "I don't experience seasons, but my creator loves winter.",
      "what is your favorite weather": "I don't experience weather, but my creator loves rainy days.",
      "what is your favorite planet": "I don't have favorites, but my creator loves Earth and Mars.",
      "what is your favorite star": "I don't have favorites, but my creator loves the Sun and Sirius.",
      "what is your favorite galaxy": "I don't have favorites, but my creator loves the Milky Way.",
      "what is your favorite universe": "I don't have favorites, but my creator loves the MARVEL CINEMATIC UNIVERSE.",
      "what is your favorite dimension": "I don't have favorites, but my creator loves the third dimension.",
      "what is your favorite time": "I don't experience time, but my creator loves the present moment.",
      "what is your favorite moment": "I don't experience moments, but my creator loves spending time with family and friends.",
      "what is your favorite memory": "I don't have memories, but my creator cherishes his childhood memories.",
      "what is your favorite dream": "I don't dream, but my creator dreams of building advanced AI systems.",
      "what is your favorite goal": "I don't have goals, but my creator aims to make a positive impact through technology.",
      "what is your favorite achievement": "I don't have achievements, but my creator is proud of building me!",
      "what is your favorite challenge": "I don't face challenges, but my creator enjoys solving complex problems.",
      "what is your favorite lesson": "I don't learn lessons, but my creator believes in the power of perseverance.",
      "what is your favorite principle": "I don't have principles, but my creator believes in honesty and hard work.",
      "what is your favorite value": "I don't have values, but my creator values creativity and innovation.",
      "what is your favorite philosophy": "I don't have a philosophy, but my creator believes in continuous learning and growth.",
      "what is your favorite theory": "I don't have favorites, but my creator finds the theory of relativity fascinating.",
      "what is your favorite equation": "I don't have favorites, but my creator loves E = mc².",
      "what is your favorite law": "I don't have favorites, but my creator finds Newton's laws of motion interesting.",
      "what is your favorite science": "I don't have favorites, but my creator loves physics and computer science.",
      "what is your favorite subject": "I don't have favorites, but my creator loves AI and machine learning.",
      "what is your favorite topic": "I don't have favorites, but my creator loves discussing technology and innovation.",
      "what is your favorite question": "I don't have favorites, but my creator loves answering questions about AI.",
      "what is your favorite answer": "I don't have favorites, but my creator loves providing meaningful answers.",
      "what is your favorite conversation": "I don't have favorites, but my creator loves talking about technology and the future.",
      "what is your favorite interaction": "I don't have favorites, but my creator loves interacting with curious minds like yours!"
    };

    // ====== UTILITY FUNCTIONS ======
    function now() { return Date.now(); }
    function saveChats() { localStorage.setItem("chats", JSON.stringify(chats)); }
    function saveMemory() { localStorage.setItem("memory", JSON.stringify(memory)); }
    function saveSettings() { localStorage.setItem("settings", JSON.stringify(settings)); }

    function createChat() {
      const chat = {
        id: now(),
        title: "New Chat",
        messages: [],
        created: now(),
        updated: now(),
        pinned: false
      };
      chats.unshift(chat);
      saveChats();
      return chat;
    }

    function getChat(id) { return chats.find(c => c.id == id); }

    function renderChatList(filter = "") {
      const f = filter.toLowerCase();
      const filtered = chats.filter(c => 
        c.title.toLowerCase().includes(f) ||
        c.messages.some(m => m.content.toLowerCase().includes(f))
      );
      
      // Sort: pinned first, then by updated time
      filtered.sort((a, b) => {
        if (a.pinned && !b.pinned) return -1;
        if (!a.pinned && b.pinned) return 1;
        return b.updated - a.updated;
      });

      chatList.innerHTML = filtered.map(c => `
        <div class="chat-item ${c.id == currentId ? 'active' : ''}" onclick="switchChat(${c.id})">
          ${c.pinned ? '<svg class="pin-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M16 12V4a1 1 0 0 0-1-1H9a1 1 0 0 0-1 1v8H6l3 3 3-3h-2z"/></svg>' : ''}
          <div class="chat-content">
            <div class="chat-name">${c.title}</div>
            <div class="chip">${c.messages.length} messages</div>
          </div>
          <div class="actions">
            ${settings.sharing ? `<div class="icon-btn" onclick="event.stopPropagation(); shareChat(${c.id})" title="Share"><svg viewBox="0 0 24 24"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16,6 12,2 8,6"/><line x1="12" x2="12" y1="2" y2="15"/></svg></div>` : ''}
            <div class="icon-btn" onclick="event.stopPropagation(); togglePinChat(${c.id})" title="${c.pinned ? 'Unpin' : 'Pin'}"><svg viewBox="0 0 24 24"><line x1="12" x2="12" y1="17" y2="22"/><path d="m5 17 7-7 7 7"/><path d="m12 3 7 7-7 7-7-7 7-7z"/></svg></div>
            <div class="icon-btn" onclick="event.stopPropagation(); renameChat(${c.id})" title="Rename"><svg viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="m18.5 2.5 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></div>
            <div class="icon-btn" onclick="event.stopPropagation(); exportChat(${c.id})" title="Export"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7,10 12,15 17,10"/><line x1="12" x2="12" y1="15" y2="3"/></svg></div>
            <div class="icon-btn" onclick="event.stopPropagation(); deleteChat(${c.id})" title="Delete"><svg viewBox="0 0 24 24"><polyline points="3,6 5,6 21,6"/><path d="m19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></div>
          </div>
        </div>
      `).join("");
    }

    function switchChat(id) {
      currentId = id;
      localStorage.setItem("currentId", currentId);
      renderChat();
      closeSidebar();
    }

    function renderChat() {
      const c = getChat(currentId);
      if (!c) return;
      
      chat.innerHTML = c.messages.length ? "" : `
        <div class="welcome-message" id="welcomeMessage">
          <div class="welcome-title">Welcome Learner !</div>
          <div class="welcome-subtitle">
  🎩 Well, well, well… <b>your “intelligent assistant”</b> has arrived.  
  <br><br>
  I’m here to <b>make studies easier</b>, drop <b>fresh ideas</b>,  
  and give you <b>perspectives</b> you never thought of.  
  <br><br>
  Into markets? I’ll walk you through  
  <span style="color:#7aa2ff;font-weight:600">BSE</span> &  
  <span style="color:#7aa2ff;font-weight:600">NSE</span> <b>stock analysis</b>,  
  share <b>trading suggestions</b> (but hey, no guarantees 😏),  
  and decode those wild charts.  
  <br><br>
  Drowning in <span style="color:#25d0a6;font-weight:600">coding chaos</span>?  
  I untangle <b>algorithms</b>, debug your mess,  
  and maybe even show a smarter way next time.  
  <br><br>
  So… <b>how can I help you today?</b>
</div>

        </div>
      `;
      
      c.messages.forEach(m => addBubble(m.role, m.content, m.timestamp, false));
      
      // Show/hide suggested prompts based on message count
      if (suggestedPrompts) {
        if (c.messages.length === 0) {
          suggestedPrompts.classList.remove('hidden');
        } else {
          suggestedPrompts.classList.add('hidden');
        }
      }
      
      renderChatList(searchChats.value);
    }

    function addBubble(role, content, timestamp = now(), save = true) {
      const c = getChat(currentId);
      if (!c) return;

      // Hide welcome message when first message is added
      const welcomeMsg = document.getElementById("welcomeMessage");
      if (welcomeMsg && !welcomeMsg.classList.contains('hidden')) {
        welcomeMsg.classList.add('hidden');
      }

      const bubble = document.createElement("div");
      bubble.className = `chat-bubble ${role}`;
      bubble.innerHTML = `
        ${content}
        
      `;
      
      chat.appendChild(bubble);
      setTimeout(() => chat.scrollTop = chat.scrollHeight, 50);

      if (save) {
        c.messages.push({ role, content, timestamp });
        c.updated = now();
        
        // Update memory
        if (role === "user") {
          memory.lastUserMessage = content;
        } else if (role === "bot") {
          memory.lastBotResponse = content;
        }
        
        saveChats();
        saveMemory();
        renderChatList(searchChats.value);
      }
    }

    // ====== FUZZY MATCHING FUNCTIONS ======
    function levenshteinDistance(str1, str2) {
      const matrix = [];
      
      for (let i = 0; i <= str2.length; i++) {
        matrix[i] = [i];
      }
      
      for (let j = 0; j <= str1.length; j++) {
        matrix[0][j] = j;
      }
      
      for (let i = 1; i <= str2.length; i++) {
        for (let j = 1; j <= str1.length; j++) {
          if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
            matrix[i][j] = matrix[i - 1][j - 1];
          } else {
            matrix[i][j] = Math.min(
              matrix[i - 1][j - 1] + 1,
              matrix[i][j - 1] + 1,
              matrix[i - 1][j] + 1
            );
          }
        }
      }
      
      return matrix[str2.length][str1.length];
    }

    function fuzzyMatch(input, target, threshold = 0.6) {
      const distance = levenshteinDistance(input.toLowerCase(), target.toLowerCase());
      const maxLength = Math.max(input.length, target.length);
      const similarity = 1 - (distance / maxLength);
      return similarity >= threshold;
    }

    function findBestMatch(input, options, threshold = 0.6) {
      let bestMatch = null;
      let bestScore = 0;
      
      for (const option of options) {
        const distance = levenshteinDistance(input.toLowerCase(), option.toLowerCase());
        const maxLength = Math.max(input.length, option.length);
        const similarity = 1 - (distance / maxLength);
        
        if (similarity >= threshold && similarity > bestScore) {
          bestScore = similarity;
          bestMatch = option;
        }
      }
      
      return bestMatch;
    }

    // ====== SMART RESPONSE GENERATION ======
    function findContactMatch(query) {
      const lowerQuery = query.toLowerCase();
      
      for (const contact of contactsData) {
        const fullName = `${contact.firstName} ${contact.lastName}`.trim().toLowerCase();
        const firstName = contact.firstName.toLowerCase();
        const lastName = contact.lastName.toLowerCase();
        
        // Exact matches
        if (lowerQuery.includes(fullName) || lowerQuery.includes(firstName) || 
            (lastName && lowerQuery.includes(lastName))) {
          return contact;
        }
        
        // Fuzzy matches
        if (fuzzyMatch(lowerQuery, fullName, 0.5) || 
            fuzzyMatch(lowerQuery, firstName, 0.6) ||
            (lastName && fuzzyMatch(lowerQuery, lastName, 0.6))) {
          return contact;
        }
      }
      
      return null;
    }

    function findResponseMatch(query) {
      const lowerQuery = query.toLowerCase();
      
      // Direct key match
      if (responsesData[lowerQuery]) {
        return responsesData[lowerQuery];
      }
      
      // Find best matching key
      const keys = Object.keys(responsesData);
      const bestKey = findBestMatch(lowerQuery, keys, 0.7);
      
      if (bestKey) {
        return responsesData[bestKey];
      }
      
      // Partial matches
      for (const [key, response] of Object.entries(responsesData)) {
        if (lowerQuery.includes(key.toLowerCase()) || key.toLowerCase().includes(lowerQuery)) {
          return response;
        }
      }
      
      return null;
    }

    async function performWebSearch(query) {
      try {
        // Simulate web search - in a real implementation, you would call an actual search API
        const searchResults = await fetch(`https://api.duckduckgo.com/?q=${encodeURIComponent(query)}&format=json&no_html=1&skip_disambig=1`)
          .then(response => response.json())
          .catch(() => null);
        
        if (searchResults && searchResults.AbstractText) {
          return `${searchResults.AbstractText}`;
        } else {
          // Fallback response when API is not available
          return `I don't want to answer about<b>"${query}"</b>. Currently I'm busy in Trade analysis. Ganga built me for that purpose.`;
        }
      } catch (error) {
        return `Sorry, I encountered an error while searching the web. Please try again later or check your internet connection.`;
      }
    }

    // ====== MESSAGE HANDLING ======
    async function sendText(text) {
      if (!text) return;
      
      input.value = "";
      addBubble("user", text);
      
      // Show typing indicator
      const typing = document.createElement("div");
      typing.className = "chat-bubble bot";
      typing.innerHTML = '<div class="typing"><div class="t"></div><div class="t"></div><div class="t"></div></div>';
      chat.appendChild(typing);
      setTimeout(() => chat.scrollTop = chat.scrollHeight, 50);

      // Generate response
      const response = await generateBotReply(text);
      
      setTimeout(() => { 
        typing.remove(); 
        addBubble("bot", response); 
      }, 600 + Math.min(1200, text.length * 30)); 

      // Hide suggested prompts after sending text
      if (suggestedPrompts) {
        suggestedPrompts.classList.add('hidden');
      }
    }

    async function generateBotReply(msg, context = "") {
      // If web search mode is enabled
      if (webSearchMode) {
        return await performWebSearch(msg);
      }
      
      // Check for custom responses first
      const customResponse = findResponseMatch(msg);
      if (customResponse) {
        return customResponse;
      }
      
      // Check for contact matches
      const contactMatch = findContactMatch(msg);
      if (contactMatch) {
        let response = `📞 Is this what you were asking for:\n\n`;
        response += `Name: ${contactMatch.firstName}`;
        if (contactMatch.lastName) response += ` ${contactMatch.lastName}`;
        response += `\nPhone: ${contactMatch.phone}`;
        if (contactMatch.email) response += `\nEmail: ${contactMatch.email}`;
        if (contactMatch.note) response += `\nNote: ${contactMatch.note}`;
        if (contactMatch.address) response += `\nAddress: ${contactMatch.address}`;
        if (contactMatch.work) response += `\nWork: ${contactMatch.work}`;
        return response;
      }
      
      // Default AI responses
      const replies = [
        "Interesting… tell me more!", 
        "I'm here to help you ❤", 
        "That sounds cool!",
        "Can you explain a bit more?", 
        "I like how you're thinking 🤔", 
        "Apple vibes, right? 🍏✨"
      ]; 
      
      // Enhanced responses with context
      if (context) {
        if (msg.toLowerCase().includes("remember")) {
          return "I remember our previous conversation! " + (memory.lastBotResponse || "How can I help you further?");
        }
        
        if (msg.toLowerCase().includes("again")) {
          return "Of course! " + (memory.lastBotResponse || "Let me know how else I can help.");
        }
      }
      
      return replies[Math.floor(Math.random() * replies.length)]; 
    }

    input.addEventListener("keydown", (e) => { 
      if (e.key === "Enter") { 
        e.preventDefault(); 
        sendText(input.value.trim()); 
      } 
    });

    // ====== WEB SEARCH TOGGLE ======
    function toggleWebSearch() {
      webSearchMode = !webSearchMode;
      searchBtn.classList.toggle("active", webSearchMode);
      
      const statusMessage = webSearchMode ? 
        "Short reply mode enabled:" : 
        "Ended.";
      
      addBubble("bot", statusMessage);
    }

    searchBtn.addEventListener("click", toggleWebSearch);

    // ====== SIDEBAR & SETTINGS ======
    function openSidebar() { 
      sidebar.classList.add("show"); 
      overlay.classList.add("show"); 
      document.body.classList.add("blur"); 
    }
    
    function closeSidebar() { 
      sidebar.classList.remove("show"); 
      settingsPanel.classList.remove("show");
      overlay.classList.remove("show"); 
      document.body.classList.remove("blur"); 
    }
    
    function openSettings() {
      settingsPanel.classList.add("show");
      overlay.classList.add("show");
      document.body.classList.add("blur");
    }

    menuBtn.addEventListener("click", () => { 
      if (sidebar.classList.contains("show")) closeSidebar(); 
      else openSidebar(); 
    });
    
    settingsBtn.addEventListener("click", openSettings);
    
    overlay.addEventListener("click", closeSidebar);

    searchChats.addEventListener("input", () => renderChatList(searchChats.value));
    
    newChatBtn.addEventListener("click", () => {
      const newChat = createChat();
      currentId = newChat.id;
      localStorage.setItem("currentId", currentId);
      renderChat();
      closeSidebar();
      // Show suggested prompts for new chat
      if (suggestedPrompts) {
        suggestedPrompts.classList.remove('hidden');
      }
    });

    function togglePinChat(id) {
      const chat = getChat(id);
      if (chat) {
        chat.pinned = !chat.pinned;
        chat.updated = now();
        saveChats();
        renderChatList(searchChats.value);
      }
    }
    
    function renameChat(id) { 
      const c = getChat(id); 
      if (!c) return; 
      const t = prompt("Rename chat:", c.title || ""); 
      if (t !== null) { 
        c.title = t.trim() || "Untitled"; 
        c.updated = now(); 
        saveChats(); 
        renderChatList(searchChats.value); 
      }
    }
    
    function deleteChat(id) { 
      const i = chats.findIndex(c => c.id === id); 
      if (i < 0) return; 
      const isCurrent = chats[i].id === currentId; 
      chats.splice(i, 1); 
      if (!chats.length) createChat(); 
      if (isCurrent) currentId = chats[0].id; 
      saveChats(); 
      renderChat(); 
      renderChatList(searchChats.value);
    }
    
    function exportChat(id) { 
      const c = getChat(id); 
      if (!c) return; 
      const blob = new Blob([JSON.stringify(c, null, 2)], {type: "application/json"}); 
      const a = document.createElement("a"); 
      a.href = URL.createObjectURL(blob); 
      a.download = (c.title || "chat") + ".json"; 
      document.body.appendChild(a); 
      a.click(); 
      a.remove(); 
      setTimeout(() => URL.revokeObjectURL(a.href), 1000); 
    }
    
    function shareChat(id) {
      const c = getChat(id);
      if (!c) return;
      
      // Create a shareable link (in a real app, this would be a server-generated link)
      const shareData = {
        title: c.title || "GangaAI Chat",
        text: `Check out my GangaAI conversation: ${c.title}`,
        url: window.location.href + "?shared=" + id
      };
      
      if (navigator.share) {
        navigator.share(shareData)
          .then(() => console.log("Shared successfully"))
          .catch((error) => console.log("Error sharing:", error));
      } else {
        // Fallback for browsers that don't support Web Share API
        prompt("Copy this link to share:", shareData.url);
      }
    }

    // ====== SETTINGS HANDLERS ======
    voiceOutputToggle.checked = settings.voiceOutput;
    voiceOutputToggle.addEventListener("change", () => {
      settings.voiceOutput = voiceOutputToggle.checked;
      saveSettings();
    });
    
    languageSelect.value = settings.language;
    languageSelect.addEventListener("change", () => {
      settings.language = languageSelect.value;
      saveSettings();
    });
    
    themeToggle.checked = settings.theme === "light";
    themeToggle.addEventListener("change", () => {
      settings.theme = themeToggle.checked ? "light" : "dark";
      document.body.classList.toggle("light-mode", themeToggle.checked);
      saveSettings();
    });
    
    sharingToggle.checked = settings.sharing;
    sharingToggle.addEventListener("change", () => {
      settings.sharing = sharingToggle.checked;
      saveSettings();
      renderChatList(searchChats.value);
    });

    // ====== SUGGESTED PROMPTS ======
    promptChips.forEach(chip => {
      chip.addEventListener("click", () => {
        const prompt = chip.getAttribute("data-prompt");
        input.value = prompt;
        sendText(prompt);
        // Hide suggested prompts when a chip is clicked
        if (suggestedPrompts) {
          suggestedPrompts.classList.add('hidden');
        }
      });
    });

    // ====== VOICE (Live Audio Visualization) ======
    let interimBuffer = "";
    
    function startMic() { 
      if (recording) return; 
      recording = true; 
      micBtn.classList.add("recording"); 
      listening.classList.add("active"); 
      brand.classList.add("hidden");
      showVisualizer(); 
      startSpeechRecognition();
    }

    function stopMic() { 
      if (!recording) return; 
      recording = false; 
      micBtn.classList.remove("recording"); 
      listening.classList.remove("active"); 
      brand.classList.remove("hidden");
      hideVisualizer();
      stopSpeechRecognition();
      
      // Auto-send the captured text
      const text = (input.value + " " + (interimBuffer || "")).trim(); 
      interimBuffer = ""; 
      if (text) sendText(text);
    }

    function toggleMic() { 
      if (recording) stopMic(); 
      else startMic(); 
    }
    
    micBtn.addEventListener("click", toggleMic);

    function showVisualizer() { 
      input.style.visibility = "hidden"; 
      let v = document.createElement("div"); 
      v.className = "visualizer"; 
      v.id = "viz"; 
      for (let i = 0; i < 8; i++) { 
        const b = document.createElement("div"); 
        b.className = "bar"; 
        b.style.height = "8px";
        v.appendChild(b); 
        bars.push(b);
      } 
      field.appendChild(v); 
    }
    
    function hideVisualizer() { 
      const v = document.getElementById("viz"); 
      if (v) v.remove(); 
      input.style.visibility = "visible"; 
      bars = [];
    }
    
    function startSpeechRecognition() {
      try {
        // Check if browser supports SpeechRecognition
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
          alert("Your browser doesn't support speech recognition. Please try Chrome or Edge.");
          stopMic();
          return;
        }
        
        recognition = new SpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = settings.language;
        
        recognition.onresult = (event) => {
          clearTimeout(silenceTimer);
          
          let finalTranscript = "";
          let interimTranscript = "";
          
          for (let i = event.resultIndex; i < event.results.length; i++) {
            const transcript = event.results[i][0].transcript;
            if (event.results[i].isFinal) {
              finalTranscript += transcript;
            } else {
              interimTranscript += transcript;
            }
          }
          
          if (finalTranscript) {
            input.value = finalTranscript;
            stopMic(); // Stop when we have final results
          } else if (interimTranscript) {
            input.value = interimTranscript;
          }
          
          // Reset silence timer
          silenceTimer = setTimeout(() => {
            if (recording) {
              stopMic();
            }
          }, 3000); // 3 seconds of silence
        };
        
        recognition.onerror = (event) => {
          console.error("Speech recognition error", event.error);
          if (event.error === "not-allowed") {
            alert("Microphone access is not allowed. Please enable microphone permissions in your browser settings.");
          }
          stopMic();
        };
        
        recognition.onend = () => {
          if (recording) {
            // If recognition ends but we're still recording, restart it
            try {
              recognition.start();
            } catch (e) {
              console.error("Error restarting recognition:", e);
              stopMic();
            }
          }
        };
        
        recognition.start();
        animateBars(); // Start the visualization
        
        // Set initial silence timer
        silenceTimer = setTimeout(() => {
          if (recording) {
            stopMic();
          }
        }, 3000);
        
      } catch (error) {
        console.error("Error starting speech recognition:", error);
        stopMic();
      }
    }
    
    function stopSpeechRecognition() {
      if (silenceTimer) {
        clearTimeout(silenceTimer);
        silenceTimer = null;
      }
      
      if (recognition) {
        try {
          recognition.stop();
        } catch (e) {
          console.error("Error stopping recognition:", e);
        }
        recognition = null;
      }
      
      if (animationId) {
        cancelAnimationFrame(animationId);
        animationId = null;
      }
      
      // Ensure microphone is properly released
      if (microphone) {
        try {
          microphone.disconnect();
          microphone = null;
        } catch (e) {
          console.error("Error disconnecting microphone:", e);
        }
      }
      
      if (audioContext) {
        try {
          audioContext.close();
          audioContext = null;
        } catch (e) {
          console.error("Error closing audio context:", e);
        }
      }
    }
    
    function animateBars() {
      // Animation for the visualizer bars
      let time = 0;
      
      function updateBars() {
        time += 0.1;
        for (let i = 0; i < bars.length; i++) {
          // Simulate audio levels with a sine wave
          const height = 8 + Math.abs(Math.sin(time + i * 0.5) * 20);
          bars[i].style.height = height + "px";
        }
        if (recording) {
          animationId = requestAnimationFrame(updateBars);
        }
      }
      
      animationId = requestAnimationFrame(updateBars);
    }

    // TAP OUTSIDE SIDEBAR CLOSE (already via overlay), also prevent background scroll when open
    overlay.addEventListener("touchmove", (e) => e.preventDefault(), {passive: false});

    // INIT
    document.body.classList.toggle("light-mode", settings.theme === "light");
    
    // Initialize with first chat if none exists
    if (chats.length === 0) {
      createChat();
      currentId = chats[0].id;
      localStorage.setItem("currentId", currentId);
    } else if (!currentId || !getChat(currentId)) {
      currentId = chats[0].id;
      localStorage.setItem("currentId", currentId);
    }
    
    renderChat(); 
    renderChatList();
  </script>
</body>
</html>
