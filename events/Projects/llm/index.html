<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>GangaAI</title>
  <style>
    /* RESET */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; overflow: hidden; }
    body { font-family: -apple-system, BlinkMacMacSystemFont, "SF Pro Text", BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #0f0f0f; color: #fff; }
    body.light-mode { background: #f5f5f7; color: #000; }
    body.light-mode::before { background: radial-gradient(1200px 800px at 10% -10%, #e5e5e7 10%, #f5f5f7 60%); }
    body.light-mode::after { background: rgba(255,255,255,0.7); }
    
    /* Light mode styling fixes */
    body.light-mode .input-area { background: rgba(255,255,255,0.8); }
    body.light-mode .chat-bubble.bot { background: rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.05); }
    body.light-mode .sidebar, body.light-mode .side-search, body.light-mode .chat-item, 
    body.light-mode .icon-btn { background: rgba(255,255,255,0.9); border-color: rgba(0,0,0,0.1); }
    body.light-mode .new-chat-btn { background: rgba(255,255,255,0.9); border-color: rgba(0,0,0,0.1); color: #000; }
    body.light-mode .settings-panel { background: rgba(255,255,255,0.95); border-color: rgba(0,0,0,0.1); }
    body.light-mode .settings-content { background: rgba(255,255,255,0.95); }
    body.light-mode .side-head .side-title { color: #000; }
    body.light-mode .settings-section h3 { color: #000; }
    body.light-mode .settings-option span { color: #000; }
    body.light-mode select { background: rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.1); color: #000; }
    body.light-mode .prompt-chip { background: rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.1); color: #000; }
    body.light-mode .input-area .field input { color: #000; }
    body.light-mode .input-area .field input::placeholder { color: #666; }
    body.light-mode .side-search input { color: #000; }
    body.light-mode .side-search input::placeholder { color: #666; }
    body.light-mode .chat-name { color: #000; }
    body.light-mode .chip { color: #666; }
    
    /* Icon color fixes for light mode */
    body.light-mode .menu svg { stroke: #000; }
    body.light-mode .settings-btn svg { stroke: #000; }
    body.light-mode .icon-btn svg { stroke: #000; }
    body.light-mode .side-search svg { stroke: #000; }
    body.light-mode .feature-icon { stroke: #000; }

    /* BACKGROUND */
    body::before { content: ""; position: fixed; inset: 0; background: radial-gradient(1200px 800px at 10% -10%, #1d1d1f 10%, #0a0a0a 60%); z-index: -2; transition: background 0.3s ease; }
    body::after { content: ""; position: fixed; inset: 0; backdrop-filter: blur(22px) saturate(180%); background: rgba(255,255,255,0.05); z-index: -1; transition: backdrop-filter .3s ease, background .3s ease; }
    body.blur::after { backdrop-filter: blur(35px) saturate(220%); background: rgba(255,255,255,0.15); }

    /* HEADER */
    header { position: fixed; top: 0; left: 0; right: 0; height: 60px; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 20px; font-weight: 600; background: rgba(255,255,255,0.06); backdrop-filter: blur(15px); border-bottom: 1px solid rgba(255,255,255,0.12); z-index: 200; transition: backdrop-filter 0.3s ease; }
    body.blur header { backdrop-filter: blur(25px); }
    .brand { letter-spacing: .3px; transition: opacity 0.3s ease; }
    .brand.hidden { opacity: 0; }
    .listening { position: absolute; display: flex; align-items: center; gap: 6px; font-size: 16px; font-weight: 500; opacity: 0; transition: opacity 0.3s ease; }
    .listening.active { opacity: 1; }
    .dot { width: 6px; height: 6px; border-radius: 50%; background: #34c759; animation: pulse 1.2s infinite ease-in-out; }
    .dot:nth-child(2){ animation-delay:.15s } .dot:nth-child(3){ animation-delay:.3s }
    @keyframes pulse { 0%,100%{ transform: scale(.8); opacity:.5 } 50%{ transform: scale(1.3); opacity:1 } }

    /* HAMBURGER / SIDEBAR TOGGLE */
    .menu { position: absolute; left: 10px; top: 10px; width: 40px; height: 40px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.06); display: grid; place-items:center; cursor: pointer; transition: transform .15s ease; }
    .menu:active { transform: scale(0.95); }
    .menu svg { width: 22px; height: 22px; fill: none; stroke: #fff; stroke-width: 2; stroke-linecap: round; }
    .settings-btn { position: absolute; right: 10px; top: 10px; width: 40px; height: 40px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.06); display: grid; place-items:center; cursor: pointer; transition: transform .15s ease; }
    .settings-btn:active { transform: scale(0.95); }
    .settings-btn svg { width: 22px; height: 22px; fill: none; stroke: #fff; stroke-width: 2; stroke-linecap: round; }

    /* CHAT CONTAINER */
    .chat-container { position: absolute; top: 60px; bottom: 60px; left: 0; right: 0; overflow-y: auto; overflow-x: hidden; padding: 14px; display: flex; flex-direction: column; gap: 8px; scroll-behavior: smooth; -webkit-overflow-scrolling: touch; }
    .chat-container::-webkit-scrollbar { display: none; }

    /* COMPACT CHAT BUBBLES */
    .chat-bubble { max-width: 75%; padding: 8px 12px; border-radius: 16px; font-size: 14px; line-height: 1.4; word-wrap: break-word; overflow-wrap: anywhere; white-space: pre-wrap; animation: pop .25s ease; position: relative; }
    .user { align-self: flex-end; background: linear-gradient(135deg, #007aff, #5ac8fa); color: #fff; border-bottom-right-radius: 4px; }
    .bot { align-self: flex-start; background: rgba(255,255,255,0.10); border: 1px solid rgba(255,255,255,0.10); backdrop-filter: blur(10px); border-bottom-left-radius: 4px; }
    .message-time { font-size: 9px; opacity: 0.7; margin-top: 3px; text-align: right; }
    .bot .message-time { text-align: left; }
    @keyframes pop { from{ opacity: 0; transform: translateY(8px) } to{ opacity:1; transform: translateY(0) } }

    /* TYPING INDICATOR */
    .typing { display: inline-flex; gap: 4px; align-items: center; }
    .typing .t { width:5px; height:5px; border-radius:50%; background:#d1d1d6; animation: type 1s infinite; }
    .typing .t:nth-child(2){ animation-delay:.15s } .t:nth-child(3){ animation-delay:.3s }
    @keyframes type { 0%,100%{ transform: translateY(0); opacity:.5 } 50%{ transform: translateY(-4px); opacity:1 } }

    /* INPUT AREA - Invisible background with dynamic blur */
    .input-area { position: fixed; bottom: 0; left: 0; right: 0; height: 60px; background: transparent; backdrop-filter: blur(20px); display: flex; align-items: center; padding: 10px; gap: 10px; z-index: 100; transition: backdrop-filter 0.3s ease; }
    body.blur .input-area { backdrop-filter: blur(30px); }
    .field-wrap { position: relative; flex: 1; height: 36px; }
    .field { position: absolute; inset: 0; display: flex; align-items: center; border-radius: 18px; background: transparent; padding: 0 14px; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); }
    .field input { flex: 1; height: 32px; border: none; outline: none; font-size: 16px; background: transparent; color: #fff; }
    .field input::placeholder { color: #999; }

    /* SUGGESTED PROMPTS */
    .suggested-prompts { position: absolute; bottom: 68px; left: 0; right: 0; padding: 10px; display: flex; gap: 8px; overflow-x: auto; scrollbar-width: none; transition: opacity 0.3s ease, transform 0.3s ease; }
    .suggested-prompts::-webkit-scrollbar { display: none; }
    .prompt-chip { padding: 6px 12px; background: rgba(255,255,255,0.10); border-radius: 14px; font-size: 12px; white-space: nowrap; cursor: pointer; transition: transform 0.1s ease; backdrop-filter: blur(10px); }
    .prompt-chip:active { transform: scale(0.95); }
    .suggested-prompts.hidden { opacity: 0; pointer-events: none; transform: translateY(10px); }

    /* LIVE MIC VISUALIZER */
    .visualizer { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; gap: 3px; padding: 0 18px; background: rgba(255,255,255,0.10); border-radius: 18px; }
    .bar { width: 3px; background: linear-gradient(180deg, #34c759, #30d158); border-radius: 2px; height: 8px; }
    
    /* MIC BUTTON */
    .mic-btn { width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, #ff3b30, #ff2d55); display: grid; place-items: center; cursor: pointer; transition: transform .12s ease, filter .2s ease; }
    .mic-btn:active { transform: scale(.95); }
    .mic-btn svg { width: 18px; height: 18px; fill: #fff; }
    .mic-btn.recording { background: linear-gradient(135deg, #ff453a, #ff375f); box-shadow: 0 0 0 6px rgba(255,56,95,0.15); }

    /* SIDEBAR - COMPACT LAYOUT */
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.25); opacity: 0; pointer-events: none; transition: opacity .25s ease; z-index: 250; }
    .overlay.show { opacity: 1; pointer-events: auto; }
    .sidebar { position: fixed; top: 10px; left: 10px; bottom: 10px; width: 86%; max-width: 320px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.12); border-radius: 20px; backdrop-filter: blur(20px); transform: translateX(-120%); transition: transform .28s cubic-bezier(.2,.8,.2,1); z-index: 300; display: flex; flex-direction: column; overflow: hidden; }
    .sidebar.show { transform: translateX(0); }
    
    /* COMPACT SIDEBAR HEADER - Single line layout */
    .side-head { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; border-bottom: 1px solid rgba(255,255,255,0.12); background: linear-gradient(135deg, rgba(255,255,255,0.12), rgba(255,255,255,0.06)); }
    .sidebar-brand { display: flex; align-items: center; gap: 8px; flex: 1; }    .sidebar-logo { width: 40px; height: 40px; border-radius: 10px; box-shadow: 0 3px 10px rgba(0,0,0,0.2); }
    .side-title { font-weight: 600; font-size: 16px; background: linear-gradient(135deg, #007aff, #5ac8fa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .chat-bubble { max-width: 70%; padding: 6px 10px; border-radius: 14px; font-size: 13px; line-height: 1.3; word-wrap: break-word; overflow-wrap: anywhere; white-space: pre-wrap; animation: pop .25s ease; position: relative; }
    .new-chat-btn:active { transform: scale(0.95); }
    
    .side-search { margin: 8px 12px; display: flex; align-items: center; gap: 6px; background: rgba(255,255,255,0.10); border: 1px solid rgba(255,255,255,0.12); border-radius: 12px; padding: 6px 8px; }
    .side-search input { flex:1; border:none; outline:none; background:transparent; color:#fff; font-size:13px; }
    .side-search input::placeholder { color: #999; }
    .side-search svg { width: 14px; height: 14px; }

    .chats { overflow-y:auto; padding: 6px 12px; display:flex; flex-direction:column; gap:6px; }
    .chat-item { display:flex; align-items:center; justify-content:space-between; gap:6px; padding:8px 10px; border-radius:12px; background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.10); cursor: pointer; transition: all .2s ease; position: relative; }
    .chat-item:hover { background: rgba(255,255,255,0.12); transform: translateY(-1px); }
    .chat-item.active { background: linear-gradient(135deg, rgba(0,122,255,0.2), rgba(90,200,250,0.1)); border-color: rgba(0,122,255,0.3); }
    .chat-content { flex: 1; min-width: 0; }
    .chat-name { font-size:13px; font-weight: 500; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; margin-bottom: 1px; }
    .chip { font-size: 10px; opacity:.7; }
    .pin-icon { position: absolute; top: 6px; right: 6px; width: 12px; height: 12px; opacity: 0.7; }
    .actions { display:flex; gap:3px; opacity: 0; transition: opacity .2s ease; }
    .chat-item:hover .actions { opacity: 1; }
    .icon-btn { width:24px; height:24px; display:grid; place-items:center; border-radius: 6px; border: 1px solid rgba(255,255,255,0.14); background: rgba(255,255,255,0.08); transition: all .15s ease; }
    .icon-btn:hover { background: rgba(255,255,255,0.15); }
    .icon-btn:active{ transform: scale(.95) }
    .icon-btn svg { width:12px; height:12px; stroke:#fff; stroke-width:2; fill:none; }

    /* COMPACT SETTINGS PANEL */
    .settings-panel { position: fixed; top: 10px; right: 10px; bottom: 10px; width: 86%; max-width: 280px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.12); border-radius: 20px; backdrop-filter: blur(20px); transform: translateX(120%); transition: transform .28s cubic-bezier(.2,.8,.2,1); z-index: 300; display: flex; flex-direction: column; overflow: hidden; }
    .settings-panel.show { transform: translateX(0); }
    .settings-header { display: flex; align-items: center; justify-content: center; padding: 12px 16px; border-bottom: 1px solid rgba(255,255,255,0.12); background: linear-gradient(135deg, rgba(255,255,255,0.12), rgba(255,255,255,0.06)); }
    .settings-title { font-weight: 600; font-size: 14px; background: linear-gradient(135deg, #007aff, #5ac8fa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .settings-content { padding: 12px; overflow-y: auto; }
    .settings-section { margin-bottom: 16px; }
    .settings-section h3 { margin-bottom: 8px; font-size: 14px; font-weight: 600; }
    .settings-option { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .settings-option:last-child { border-bottom: none; }
    .settings-option span { font-size: 13px; }
    .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255,255,255,0.3); transition: .4s; border-radius: 20px; }
    .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: #007AFF; }
    input:checked + .slider:before { transform: translateX(20px); }
    select { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; padding: 6px; color: #fff; font-size: 12px; }

    /* WELCOME MESSAGE - Mobile optimized */
    .welcome-message { 
      text-align: center; 
      padding: 20px 16px; 
      max-width: 350px; 
      opacity: 1; 
      transition: all 0.5s ease; 
      margin: 40px auto 0; 
      background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 20px;
      backdrop-filter: blur(20px);
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    }
    .welcome-message.hidden { 
      opacity: 0; 
      height: 0; 
      overflow: hidden; 
      padding: 0; 
      margin: 0;
      transform: translateY(-20px);
    }
    .welcome-title {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 8px;
      background: linear-gradient(135deg, #007aff, #5ac8fa);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .welcome-subtitle {
      font-size: 14px;
      opacity: 0.8;
      margin-bottom: 16px;
      line-height: 1.4;
    }
    
    /* RESPONSIVE DESIGN */
    @media (max-width: 480px) {
      .sidebar, .settings-panel { width: 90%; max-width: 300px; }
      .chat-bubble { max-width: 85%; }
      .welcome-message { max-width: 320px; margin: 20px auto 0; }
      .welcome-title { font-size: 20px; }
      .welcome-subtitle { font-size: 13px; }
    }

    @media (min-width: 768px) { 
      .chat-bubble { max-width: 600px; } 
      .sidebar { max-width: 340px; }
      .settings-panel { max-width: 300px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="menu" id="menuBtn" aria-label="Open sidebar" title="Menu">
      <svg viewBox="0 0 24 24" id="menuIcon"><path d="M4 7h16M4 12h16M4 17h16"/></svg>
    </div>
    <div class="brand">GangaAI</div>
    <div class="listening" id="listening">
      <span>Listening</span>
      <div class="dot"></div><div class="dot"></div><div class="dot"></div>
    </div>
    <div class="settings-btn" id="settingsBtn">
      <svg viewBox="0 0 24 24"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.17.1a2 2 0 0 1-2 0l-.15-.1a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v.44a2 2 0 0 1-1 1.73v2.53a2 2 0 0 1 1 1.72v.44a2 2 0 0 0 2 2h.44a2 2 0 0 1 1.73 1h2.53a2 2 0 0 1 1.72-1h.44a2 2 0 0 0 2-2v-.44a2 2 0 0 1 1-1.73V7.73a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
    </div>
  </header>

  <div class="chat-container" id="chat">
    <div class="welcome-message" id="welcomeMessage">
      <div class="welcome-title">Welcome to GangaAI</div>
      <div class="welcome-subtitle">Your intelligent AI assistant ready to help with anything you need</div>
    </div>
  </div>

  <div class="suggested-prompts" id="suggestedPrompts">
    <div class="prompt-chip" data-prompt="What can you help me with?">What can you help me with?</div>
    <div class="prompt-chip" data-prompt="Tell me a fun fact">Tell me a fun fact</div>
    <div class="prompt-chip" data-prompt="How does AI work?">How does AI work?</div>
    <div class="prompt-chip" data-prompt="Write a poem about technology">Write a poem about technology</div>
  </div>

  <div class="input-area">
    <div class="field-wrap">
      <div class="field" id="field">
        <input id="userInput" placeholder="Ask anything..." autocomplete="off" inputmode="text" />
        <!-- visualizer injected here on record -->
      </div>
    </div>
    <button class="mic-btn" id="micBtn" aria-label="Start voice input">
      <svg viewBox="0 0 24 24"><path d="M12 15c1.66 0 3-1.34 3-3V6c0-1.66-1.34-3-3-3S9 4.34 9 6v6c0 1.66 1.34 3 3 3z" fill="#fff"/><path d="M17.3 11c0 3.04-2.46 5.5-5.5 5.5S6.3 14.04 6.3 11H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-1.7z" fill="#fff"/></svg>
    </button>
  </div>

  <!-- Sidebar + overlay -->
  <div class="overlay" id="overlay"></div>
  <aside class="sidebar" id="sidebar" aria-label="Conversations">
    <div class="side-head">
      <div class="sidebar-brand">
        <img src="https://es-universe.github.io/ESRAT/apks/logo.png" alt="GangaAI Logo" class="sidebar-logo">
        <div class="side-title">Conversations</div>
      </div>
      <button class="new-chat-btn" id="newChatBtn">+ New Chat</button>
    </div>
    
    <div class="side-search">
      <svg viewBox="0 0 24 24" stroke="#fff" stroke-width="2" fill="none"><circle cx="11" cy="11" r="7"/><path d="M20 20l-3-3"/></svg>
      <input id="searchChats" placeholder="Search chats" />
    </div>
    <div class="chats" id="chatList"></div>
  </aside>

  <!-- Settings Panel -->
  <aside class="settings-panel" id="settingsPanel">
    <div class="settings-header">
      <div class="settings-title">Settings</div>
    </div>
    <div class="settings-content">
      <div class="settings-section">
        <h3>Voice</h3>
        <div class="settings-option">
          <span>Voice Output</span>
          <label class="switch">
            <input type="checkbox" id="voiceOutputToggle">
            <span class="slider"></span>
          </label>
        </div>
        <div class="settings-option">
          <span>Language</span>
          <select id="languageSelect">
            <option value="en">English</option>
            <option value="es">Spanish</option>
            <option value="fr">French</option>
            <option value="de">German</option>
            <option value="hi">Hindi</option>
            <option value="ja">Japanese</option>
          </select>
        </div>
      </div>
      <div class="settings-section">
        <h3>Theme</h3>
        <div class="settings-option">
          <span>Light Mode</span>
          <label class="switch">
            <input type="checkbox" id="themeToggle">
            <span class="slider"></span>
          </label>
        </div>
      </div>
      <div class="settings-section">
        <h3>Privacy</h3>
        <div class="settings-option">
          <span>Enable Sharing</span>
          <label class="switch">
            <input type="checkbox" id="sharingToggle">
            <span class="slider"></span>
          </label>
        </div>
      </div>
    </div>
  </aside>

  <script>
    // ====== GLOBAL VARIABLES ======
    let chats = JSON.parse(localStorage.getItem("chats")) || [];
    let currentId = localStorage.getItem("currentId") || null;
    let settings = JSON.parse(localStorage.getItem("settings")) || {
      voiceOutput: false,
      language: "en",
      theme: "dark",
      sharing: true
    };
    let memory = JSON.parse(localStorage.getItem("memory")) || {
      lastUserMessage: "",
      lastBotResponse: ""
    };

    // Voice recognition variables
    let recognition = null;
    let recording = false;
    let bars = [];
    let animationId = null;
    let silenceTimer = null;
    let microphone = null;
    let audioContext = null;

    // DOM elements
    const chat = document.getElementById("chat");
    const input = document.getElementById("userInput");
    const micBtn = document.getElementById("micBtn");
    const menuBtn = document.getElementById("menuBtn");
    const settingsBtn = document.getElementById("settingsBtn");
    const sidebar = document.getElementById("sidebar");
    const settingsPanel = document.getElementById("settingsPanel");
    const overlay = document.getElementById("overlay");
    const chatList = document.getElementById("chatList");
    const searchChats = document.getElementById("searchChats");
    const newChatBtn = document.getElementById("newChatBtn");
    const field = document.getElementById("field");
    const listening = document.getElementById("listening");
    const brand = document.querySelector(".brand");
    const suggestedPrompts = document.getElementById("suggestedPrompts");
    const promptChips = document.querySelectorAll(".prompt-chip");
    const welcomeMessage = document.getElementById("welcomeMessage");

    // Settings elements
    const voiceOutputToggle = document.getElementById("voiceOutputToggle");
    const languageSelect = document.getElementById("languageSelect");
    const themeToggle = document.getElementById("themeToggle");
    const sharingToggle = document.getElementById("sharingToggle");

    // ====== UTILITY FUNCTIONS ======
    function now() { return Date.now(); }
    function saveChats() { localStorage.setItem("chats", JSON.stringify(chats)); }
    function saveSettings() { localStorage.setItem("settings", JSON.stringify(settings)); }
    function saveMemory() { localStorage.setItem("memory", JSON.stringify(memory)); }
    function getChat(id) { return chats.find(c => c.id === id); }

    function createChat() {
      const chat = {
        id: now().toString(),
        title: "New Chat",
        messages: [],
        created: now(),
        updated: now(),
        pinned: false
      };
      chats.unshift(chat);
      saveChats();
      return chat;
    }

    // ====== CHAT RENDERING ======
    function renderChat() {
      const c = getChat(currentId);
      if (!c) {
        if (chats.length === 0) createChat();
        currentId = chats[0].id;
        localStorage.setItem("currentId", currentId);
        return renderChat();
      }

      chat.innerHTML = "";
      
      // Show welcome message if no messages
      if (c.messages.length === 0) {
        const welcomeDiv = document.createElement("div");
        welcomeDiv.className = "welcome-message";
        welcomeDiv.id = "welcomeMessage";
        welcomeDiv.innerHTML = `
          <div class="welcome-title">Welcome to GangaAI</div>
          <div class="welcome-subtitle">Your intelligent AI assistant ready to help with anything you need</div>
        `;
        chat.appendChild(welcomeDiv);
        
        // Show suggested prompts for new chat
        if (suggestedPrompts) {
          suggestedPrompts.classList.remove('hidden');
        }
      } else {
        // Hide welcome message and suggested prompts if there are messages
        if (suggestedPrompts) {
          suggestedPrompts.classList.add('hidden');
        }
        
        c.messages.forEach(m => addBubble(m.role, m.content, m.timestamp, false));
      }

      setTimeout(() => chat.scrollTop = chat.scrollHeight, 50);
    }

    function renderChatList(filter = "") {
      const filtered = chats.filter(c => 
        c.title.toLowerCase().includes(filter.toLowerCase()) ||
        c.messages.some(m => m.content.toLowerCase().includes(filter.toLowerCase()))
      );

      // Sort: pinned first, then by updated time
      filtered.sort((a, b) => {
        if (a.pinned && !b.pinned) return -1;
        if (!a.pinned && b.pinned) return 1;
        return b.updated - a.updated;
      });

      chatList.innerHTML = filtered.map(c => {
        const isActive = c.id === currentId;
        const lastMsg = c.messages[c.messages.length - 1];
        const preview = lastMsg ? lastMsg.content.substring(0, 25) + "..." : "No messages";
        
        return `
          <div class="chat-item ${isActive ? 'active' : ''}" data-id="${c.id}">
            ${c.pinned ? '<svg class="pin-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M16 12V4a1 1 0 0 0-1-1H9a1 1 0 0 0-1 1v8H6a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1h2v4a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-4h2a1 1 0 0 0 1-1v-1a1 1 0 0 0-1-1h-2z"/></svg>' : ''}
            <div class="chat-content">
              <div class="chat-name">${c.title}</div>
              <div class="chip">${preview}</div>
            </div>
            <div class="actions">
              <button class="icon-btn" onclick="renameChat('${c.id}')" title="Rename">
                <svg viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
              </button>
              <button class="icon-btn" onclick="togglePinChat('${c.id}')" title="${c.pinned ? 'Unpin' : 'Pin'}">
                <svg viewBox="0 0 24 24"><path d="M16 12V4a1 1 0 0 0-1-1H9a1 1 0 0 0-1 1v8H6a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1h2v4a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-4h2a1 1 0 0 0 1-1v-1a1 1 0 0 0-1-1h-2z"/></svg>
              </button>
              ${settings.sharing ? `<button class="icon-btn" onclick="shareChat('${c.id}')" title="Share"><svg viewBox="0 0 24 24"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16,6 12,2 8,6"/><line x1="12" y1="2" x2="12" y2="15"/></svg></button>` : ''}
              <button class="icon-btn" onclick="exportChat('${c.id}')" title="Export">
                <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7,10 12,15 17,10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
              </button>
              <button class="icon-btn" onclick="deleteChat('${c.id}')" title="Delete">
                <svg viewBox="0 0 24 24"><polyline points="3,6 5,6 21,6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
              </button>
            </div>
          </div>
        `;
      }).join("");

      // Add click handlers for chat items
      document.querySelectorAll('.chat-item').forEach(item => {
        item.addEventListener('click', (e) => {
          if (e.target.closest('.actions')) return; // Don't switch chat if clicking action buttons
          
          const chatId = item.getAttribute('data-id');
          if (chatId !== currentId) {
            currentId = chatId;
            localStorage.setItem("currentId", currentId);
            renderChat();
            renderChatList(searchChats.value); // Re-render to update active state
            closeSidebar();
          }
        });
      });
    }

    function addBubble(role, content, timestamp = now(), save = true) {
      const c = getChat(currentId);
      if (!c) return;

      // Hide welcome message when first message is sent
      const welcomeMsg = document.getElementById("welcomeMessage");
      if (welcomeMsg && !welcomeMsg.classList.contains('hidden')) {
        welcomeMsg.classList.add('hidden');
      }

      const bubble = document.createElement("div");
      bubble.className = `chat-bubble ${role}`;
      bubble.innerHTML = `
        ${content}
        <div class="message-time">${new Date(timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
      `;
      
      chat.appendChild(bubble);
      setTimeout(() => chat.scrollTop = chat.scrollHeight, 50);

      if (save) {
        c.messages.push({ role, content, timestamp });
        c.updated = now();
        
        // Update memory
        if (role === "user") {
          memory.lastUserMessage = content;
        } else if (role === "bot") {
          memory.lastBotResponse = content;
        }
        
        saveChats();
        saveMemory();
        renderChatList(searchChats.value);
      }
    }

    // ====== MESSAGE HANDLING ======
    function sendText(text) {
      if (!text) return;
      
      input.value = "";
      addBubble("user", text);
      
      // Show typing indicator
      const typing = document.createElement("div");
      typing.className = "chat-bubble bot";
      typing.innerHTML = '<div class="typing"><div class="t"></div><div class="t"></div><div class="t"></div></div>';
      chat.appendChild(typing);
      setTimeout(() => chat.scrollTop = chat.scrollHeight, 50);

      // Generate context from memory
      let context = "";
      if (memory.lastUserMessage) {
        context += ` Previous user message: ${memory.lastUserMessage}`;
      }
      if (memory.lastBotResponse) {
        context += ` Previous bot response: ${memory.lastBotResponse}`;
      }
      
      setTimeout(()=>{ 
        typing.remove(); 
        addBubble("bot", generateBotReply(text, context)); 
      }, 600 + Math.min(1200, text.length*30)); 

      // Hide suggested prompts after sending text
      if (suggestedPrompts) {
        suggestedPrompts.classList.add('hidden');
      }
    }

    function generateBotReply(msg, context=""){ 
      const replies = [
        "Interesting… tell me more!", 
        "I'm here to help you ❤", 
        "That sounds cool!",
        "Can you explain a bit more?", 
        "I like how you're thinking 🤔", 
        "Apple vibes, right? 🍏✨"
      ]; 
      
      // Enhanced responses with context
      if (context) {
        if (msg.toLowerCase().includes("remember")) {
          return "I remember our previous conversation! " + (memory.lastBotResponse || "How can I help you further?");
        }
        
        if (msg.toLowerCase().includes("again")) {
          return "Of course! " + (memory.lastBotResponse || "Let me know how else I can help.");
        }
      }
      
      return replies[Math.floor(Math.random()*replies.length)]; 
    }

    input.addEventListener("keydown", (e)=>{ 
      if(e.key==="Enter"){ 
        e.preventDefault(); 
        sendText(input.value.trim()); 
      } 
    });

    // ====== SIDEBAR & SETTINGS ======
    function openSidebar(){ 
      sidebar.classList.add("show"); 
      overlay.classList.add("show"); 
      document.body.classList.add("blur"); 
    }
    
    function closeSidebar(){ 
      sidebar.classList.remove("show"); 
      settingsPanel.classList.remove("show");
      overlay.classList.remove("show"); 
      document.body.classList.remove("blur"); 
    }
    
    function openSettings() {
      settingsPanel.classList.add("show");
      overlay.classList.add("show");
      document.body.classList.add("blur");
    }

    menuBtn.addEventListener("click", ()=>{ 
      if(sidebar.classList.contains("show")) closeSidebar(); 
      else openSidebar(); 
    });
    
    settingsBtn.addEventListener("click", openSettings);
    
    overlay.addEventListener("click", closeSidebar);

    searchChats.addEventListener("input", ()=> renderChatList(searchChats.value));
    
    newChatBtn.addEventListener("click", () => {
      const newChat = createChat();
      currentId = newChat.id;
      localStorage.setItem("currentId", currentId);
      renderChat();
      closeSidebar();
      // Show suggested prompts for new chat
      if (suggestedPrompts) {
        suggestedPrompts.classList.remove('hidden');
      }
    });

    function togglePinChat(id) {
      const chat = getChat(id);
      if (chat) {
        chat.pinned = !chat.pinned;
        chat.updated = now();
        saveChats();
        renderChatList(searchChats.value);
      }
    }
    
    function renameChat(id){ 
      const c = getChat(id); 
      if(!c) return; 
      const t = prompt("Rename chat:", c.title||""); 
      if(t !== null) { 
        c.title = t.trim()||"Untitled"; 
        c.updated = now(); 
        saveChats(); 
        renderChatList(searchChats.value); 
      }
    }
    
    function deleteChat(id){ 
      const i = chats.findIndex(c=>c.id===id); 
      if(i<0) return; 
      const isCurrent = chats[i].id===currentId; 
      chats.splice(i,1); 
      if(!chats.length) createChat(); 
      if(isCurrent) currentId = chats[0].id; 
      saveChats(); 
      renderChat(); 
      renderChatList(searchChats.value);
    }
    
    function exportChat(id){ 
      const c = getChat(id); 
      if(!c) return; 
      const blob = new Blob([JSON.stringify(c, null, 2)], {type:"application/json"}); 
      const a = document.createElement("a"); 
      a.href = URL.createObjectURL(blob); 
      a.download = (c.title||"chat") + ".json"; 
      document.body.appendChild(a); 
      a.click(); 
      a.remove(); 
      setTimeout(()=> URL.revokeObjectURL(a.href), 1000); 
    }
    
    function shareChat(id) {
      const c = getChat(id);
      if (!c) return;
      
      // Create a shareable link (in a real app, this would be a server-generated link)
      const shareData = {
        title: c.title || "GangaAI Chat",
        text: `Check out my GangaAI conversation: ${c.title}`,
        url: window.location.href + "?shared=" + id
      };
      
      if (navigator.share) {
        navigator.share(shareData)
          .then(() => console.log("Shared successfully"))
          .catch((error) => console.log("Error sharing:", error));
      } else {
        // Fallback for browsers that don't support Web Share API
        prompt("Copy this link to share:", shareData.url);
      }
    }

    // ====== SETTINGS HANDLERS ======
    voiceOutputToggle.checked = settings.voiceOutput;
    voiceOutputToggle.addEventListener("change", () => {
      settings.voiceOutput = voiceOutputToggle.checked;
      saveSettings();
    });
    
    languageSelect.value = settings.language;
    languageSelect.addEventListener("change", () => {
      settings.language = languageSelect.value;
      saveSettings();
    });
    
    themeToggle.checked = settings.theme === "light";
    themeToggle.addEventListener("change", () => {
      settings.theme = themeToggle.checked ? "light" : "dark";
      document.body.classList.toggle("light-mode", themeToggle.checked);
      saveSettings();
    });
    
    sharingToggle.checked = settings.sharing;
    sharingToggle.addEventListener("change", () => {
      settings.sharing = sharingToggle.checked;
      saveSettings();
      renderChatList(searchChats.value);
    });

    // ====== SUGGESTED PROMPTS ======
    promptChips.forEach(chip => {
      chip.addEventListener("click", () => {
        const prompt = chip.getAttribute("data-prompt");
        input.value = prompt;
        sendText(prompt);
        // Hide suggested prompts when a chip is clicked
        if (suggestedPrompts) {
          suggestedPrompts.classList.add('hidden');
        }
      });
    });

    // ====== VOICE (Live Audio Visualization) ======
    let interimBuffer="";
    
    function startMic(){ 
      if(recording) return; 
      recording = true; 
      micBtn.classList.add("recording"); 
      listening.classList.add("active"); 
      brand.classList.add("hidden");
      showVisualizer(); 
      startSpeechRecognition();
    }

    function stopMic(){ 
      if(!recording) return; 
      recording = false; 
      micBtn.classList.remove("recording"); 
      listening.classList.remove("active"); 
      brand.classList.remove("hidden");
      hideVisualizer();
      stopSpeechRecognition();
      
      // Auto-send the captured text
      const text = (input.value + " " + (interimBuffer||"")).trim(); 
      interimBuffer = ""; 
      if(text) sendText(text);
    }

    function toggleMic(){ 
      if(recording) stopMic(); 
      else startMic(); 
    }
    
    micBtn.addEventListener("click", toggleMic);

    function showVisualizer(){ 
      input.style.visibility="hidden"; 
      let v=document.createElement("div"); 
      v.className="visualizer"; 
      v.id="viz"; 
      for(let i=0;i<8;i++){ 
        const b=document.createElement("div"); 
        b.className="bar"; 
        b.style.height = "8px";
        v.appendChild(b); 
        bars.push(b);
      } 
      field.appendChild(v); 
    }
    
    function hideVisualizer(){ 
      const v=document.getElementById("viz"); 
      if(v) v.remove(); 
      input.style.visibility="visible"; 
      bars = [];
    }
    
    function startSpeechRecognition() {
      try {
        // Check if browser supports SpeechRecognition
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
          alert("Your browser doesn't support speech recognition. Please try Chrome or Edge.");
          stopMic();
          return;
        }
        
        recognition = new SpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = settings.language;
        
        recognition.onresult = (event) => {
          clearTimeout(silenceTimer);
          
          let finalTranscript = "";
          let interimTranscript = "";
          
          for (let i = event.resultIndex; i < event.results.length; i++) {
            const transcript = event.results[i][0].transcript;
            if (event.results[i].isFinal) {
              finalTranscript += transcript;
            } else {
              interimTranscript += transcript;
            }
          }
          
          if (finalTranscript) {
            input.value = finalTranscript;
            stopMic(); // Stop when we have final results
          } else if (interimTranscript) {
            input.value = interimTranscript;
          }
          
          // Reset silence timer
          silenceTimer = setTimeout(() => {
            if (recording) {
              stopMic();
            }
          }, 3000); // 3 seconds of silence
        };
        
        recognition.onerror = (event) => {
          console.error("Speech recognition error", event.error);
          if (event.error === "not-allowed") {
            alert("Microphone access is not allowed. Please enable microphone permissions in your browser settings.");
          }
          stopMic();
        };
        
        recognition.onend = () => {
          if (recording) {
            // If recognition ends but we're still recording, restart it
            try {
              recognition.start();
            } catch (e) {
              console.error("Error restarting recognition:", e);
              stopMic();
            }
          }
        };
        
        recognition.start();
        animateBars(); // Start the visualization
        
        // Set initial silence timer
        silenceTimer = setTimeout(() => {
          if (recording) {
            stopMic();
          }
        }, 3000);
        
      } catch (error) {
        console.error("Error starting speech recognition:", error);
        stopMic();
      }
    }
    
    function stopSpeechRecognition() {
      if (silenceTimer) {
        clearTimeout(silenceTimer);
        silenceTimer = null;
      }
      
      if (recognition) {
        try {
          recognition.stop();
        } catch (e) {
          console.error("Error stopping recognition:", e);
        }
        recognition = null;
      }
      
      if (animationId) {
        cancelAnimationFrame(animationId);
        animationId = null;
      }
      
      // Ensure microphone is properly released
      if (microphone) {
        try {
          microphone.disconnect();
          microphone = null;
        } catch (e) {
          console.error("Error disconnecting microphone:", e);
        }
      }
      
      if (audioContext) {
        try {
          audioContext.close();
          audioContext = null;
        } catch (e) {
          console.error("Error closing audio context:", e);
        }
      }
    }
    
    function animateBars() {
      // Animation for the visualizer bars
      let time = 0;
      
      function updateBars() {
        time += 0.1;
        for (let i = 0; i < bars.length; i++) {
          // Simulate audio levels with a sine wave
          const height = 8 + Math.abs(Math.sin(time + i * 0.5) * 20);
          bars[i].style.height = height + "px";
        }
        if (recording) {
          animationId = requestAnimationFrame(updateBars);
        }
      }
      
      animationId = requestAnimationFrame(updateBars);
    }

    // TAP OUTSIDE SIDEBAR CLOSE (already via overlay), also prevent background scroll when open
    overlay.addEventListener("touchmove", (e)=> e.preventDefault(), {passive:false});

    // INIT
    document.body.classList.toggle("light-mode", settings.theme === "light");
    
    // Initialize with first chat if none exists
    if (chats.length === 0) {
      createChat();
      currentId = chats[0].id;
      localStorage.setItem("currentId", currentId);
    } else if (!currentId || !getChat(currentId)) {
      currentId = chats[0].id;
      localStorage.setItem("currentId", currentId);
    }
    
    renderChat(); 
    renderChatList();
  </script>
</body>
</html>

